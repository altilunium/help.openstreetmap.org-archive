<meta charset="UTF-8"><link rel="stylesheet" type="text/css" href="../style.css"><div id="CALeft">
<div class="headNormal">
<h1><a href="/questions/54587/how-to-use-xml-file-generated-by-openstreetmap-carto-with-mapnik-and-postgis">How to use .xml file generated by openstreetmap-carto with mapnik and postgis</a></h1>
</div>
<div class="" id="main-body">
<div id="askform">
<table id="question-table" style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/54587/up/" id="post-54587-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-54587-score" title="current number of votes">
    0
</div>
<a class="ajax-command post-vote down" href="/vote/54587/down/" id="post-54587-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="ajax-command favorite-mark" href="/mark_favorite/54587/" id="favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </a>
<div class="favorite-count" id="favorite-count">
</div>
</div>
</td>
<td>
<div id="item-right">
<div class="question-body">
<p>Hi,</p>
<p>I'm struggling for 2 weeks now to render a map using mapnik, mapnik-python, postigs and carto. I'm able to render a map from a local .osm file and I've compiled and installed the latest mapnik library and python bidings.</p>
<p>I've exported a .osm file to a local postgis DB using osm2pgsql and using QGIS Browser (a windows postgis client) I can validate that the export was successful. In order to render a map from this DB I generated a .xml stylesheet using <code>carto -a "3.0.0" ../openstreetmap-carto/project.mml &gt; mapnik2.xml</code> and I modified project.mml and added my DB credentials like this:</p>
<pre><code>  osm2pgsql: &amp;osm2pgsql
  type: "postgis"
  dbname: "gis"
  port: "5432"
host: "localhost"
user: "maps"
password: "asdfe"
key_field: ""
geometry_field: "way"
extent: "-20037508,-20037508,20037508,20037508"
</code></pre>
<p>I checked the generated mapnik2.xml file and all DB queries now have information about my DB credentials and it looks like this (snapshot from mapnik2.xml):</p>
<pre><code>&lt;/Style&gt;
&lt;Layer name="cliffs"
maximum-scale-denominator="100000"
srs="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0.0 +k=1.0 +units=m +nadgrids=<a href="http://help.openstreetmap.org/users/2957/nullpointer">@null</a> +wktext +no_defs +over"&gt;
&lt;StyleName&gt;cliffs&lt;/StyleName&gt;
&lt;StyleName&gt;cliffs-man_made&lt;/StyleName&gt;
&lt;Datasource&gt;
&lt;Parameter name="type"&gt;&lt;![CDATA[postgis]]&gt;&lt;/Parameter&gt;
&lt;Parameter name="dbname"&gt;&lt;![CDATA[gis]]&gt;&lt;/Parameter&gt;
&lt;Parameter name="port"&gt;&lt;![CDATA[5432]]&gt;&lt;/Parameter&gt;
&lt;Parameter name="host"&gt;&lt;![CDATA[localhost]]&gt;&lt;/Parameter&gt;
&lt;Parameter name="user"&gt;&lt;![CDATA[maps]]&gt;&lt;/Parameter&gt;
&lt;Parameter name="password"&gt;&lt;![CDATA[asdfe]]&gt;&lt;/Parameter&gt;
&lt;Parameter name="key_field"&gt;&lt;![CDATA[]]&gt;&lt;/Parameter&gt;
&lt;Parameter name="geometry_field"&gt;&lt;![CDATA[way]]&gt;&lt;/Parameter&gt;
&lt;Parameter name="extent"&gt;&lt;![CDATA[-20037508,-20037508,20037508,20037508]]&gt;&lt;/Parameter&gt;
&lt;Parameter name="table"&gt;&lt;![CDATA[(SELECT
way, "natural", man_made
FROM planet_osm_line
WHERE "natural" = 'cliff' OR man_made = 'embankment'
) AS cliffs]]&gt;&lt;/Parameter&gt;
&lt;/Datasource&gt;
&lt;/Layer&gt;
</code></pre>
<p>This is the python script:
    #!/usr/bin/env python</p>
<pre><code>import mapnik
from mapnik import *

mapnik.logger.set_severity(mapnik.severity_type.Debug)

mapfile = 'mapnik2.xml'
map_output = 'mymap33.png'

m = Map(1024, 1024)
load_map(m, mapfile)
bbox=(Box2d(-6.5, 49.5, 2.1, 59))

m.zoom_to_box(bbox) 
render_to_file(m, map_output)
</code></pre>
<p>The output image is always blank and I see no errors in the logs. I also tried to use nik4.py with the same result, blank image. 
Is this because mapnik can't connect to my local postgis DB? Did I miss a step ?</p>
</div>
<div class="tags-container tags" id="question-tags">
<a class="post-tag tag-link-python" href="/tags/python/" rel="tag" title="see questions tagged 'python'">python</a>
<a class="post-tag tag-link-openstreetmap" href="/tags/openstreetmap/" rel="tag" title="see questions tagged 'openstreetmap'">openstreetmap</a>
<a class="post-tag tag-link-carto" href="/tags/carto/" rel="tag" title="see questions tagged 'carto'">carto</a>
<a class="post-tag tag-link-mapnik" href="/tags/mapnik/" rel="tag" title="see questions tagged 'mapnik'">mapnik</a>
<a class="post-tag tag-link-postgis" href="/tags/postgis/" rel="tag" title="see questions tagged 'postgis'">postgis</a>
</div>
<div class="post-controls" id="question-controls">
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        asked
        <strong>10 Feb '17, 12:11</strong>
</p>
<img alt="biliuta's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/9a081afc9d2ea8fa735de1b5c393f1b5?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/13323/biliuta">biliuta</a><br/>
<span class="score" title="36 reputation points">36</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="biliuta has one accepted answer">100%</span>
</p>
</div>
<div class="post-update-info post-update-info-edited">
<p style="line-height:12px;">
<a href="/revisions/54587/">
                edited
                <strong>10 Feb '17, 12:19</strong>
</a>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-54587">
<a name="54592"></a>
<div class="comment" id="comment-54592">
<div class="comment-score" id="post-54592-score"></div>
<div class="comment-text"><p>Switch statement logging on for your PostgresQL server &amp; you can see if the statements are getting executed.</p></div>
<div class="comment-info" id="comment-54592-info">
<span class="comment-age">(10 Feb '17, 14:05)</span>
<a class="comment-user userinfo" href="/users/647/sk53">SK53 ♦</a>
</div>
</div>
<a name="54596"></a>
<div class="comment" id="comment-54596">
<div class="comment-score" id="post-54596-score"></div>
<div class="comment-text"><p>I've enabled the logs for postgresql and it seems the queries are executed with the correct user but the image is still blank.</p></div>
<div class="comment-info" id="comment-54596-info">
<span class="comment-age">(10 Feb '17, 15:05)</span>
<a class="comment-user userinfo" href="/users/13323/biliuta">biliuta</a>
</div>
</div>
<a name="54618"></a>
<div class="comment" id="comment-54618">
<div class="comment-score" id="post-54618-score"></div>
<div class="comment-text"><p>Is there a way to see more detailed logs from mapnik library? I've compiled mapnik for debuging but I can't see any errors in the logs.</p>
<p>The logs look something like this and it repeats this pattern a lot of times (from mapnik lib when running python script):</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: agg_renderer: Start processing style</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: agg_renderer: End processing style</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: agg_renderer: Start processing style</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: agg_renderer: End processing style</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: agg_renderer: End layer processing</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: agg_renderer: Start processing layer=paths-text-name</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: agg_renderer: -- datasource=0x2cae640</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: agg_renderer: - query_extent=box2d(-6.9500000000000002,49.5000000000000000,2.5499999999999998,59.0000000000000000)</p>
<p>At the end of the log this is what it prints out:</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: agg_renderer: End map processing</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: stroker: Destroy stroker=0x3b87680</p>
<p>Mapnik LOG&gt; 2017-02-10 06:46:28: postgis_connection: postgresql connection closed - 0x2ccd430</p></div>
<div class="comment-info" id="comment-54618-info">
<span class="comment-age">(13 Feb '17, 09:05)</span>
<a class="comment-user userinfo" href="/users/13323/biliuta">biliuta</a>
</div>
</div>
<a name="54619"></a>
<div class="comment" id="comment-54619">
<div class="comment-score" id="post-54619-score"></div>
<div class="comment-text"><p>Also I have some doubts about the box that I'm trying to use in my python script: </p>
<p>bbox=(Box2d(-6.5, 49.5, 2.1, 59))</p>
<p>Can someone please explain a bit on how to use this Box2d and what parameters do I need to set? Maybe the params that I'm giving do not represent a zone of the map that I've exported to my postgisDB. I only exported the map of Bucharest not the entire world.</p></div>
<div class="comment-info" id="comment-54619-info">
<span class="comment-age">(13 Feb '17, 10:22)</span>
<a class="comment-user userinfo" href="/users/13323/biliuta">biliuta</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-54587">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-54587-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
<hr/>
<div class="tabBar">
<a name="sort-top"></a>
<div class="headQuestions">
                    One Answer:
                    </div>
<div class="tabsA"><a href="/questions/54587/how-to-use-xml-file-generated-by-openstreetmap-carto-with-mapnik-and-postgis?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/54587/how-to-use-xml-file-generated-by-openstreetmap-carto-with-mapnik-and-postgis?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/54587/how-to-use-xml-file-generated-by-openstreetmap-carto-with-mapnik-and-postgis?sort=newest" title="newest answers will be shown first">newest answers</a><a class="on" href="/questions/54587/how-to-use-xml-file-generated-by-openstreetmap-carto-with-mapnik-and-postgis?sort=votes" title="most voted answers will be shown first">popular answers</a></div>
</div>
<a name="54621"></a>
<div class="answer accepted-answer answered-by-owner" id="answer-container-54621">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/54621/up/" id="post-54621-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-54621-score" title="current number of votes">
    0
</div>
<a class="ajax-command post-vote down" href="/vote/54621/down/" id="post-54621-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="accept-answer on" href="/accept_answer/54621/" rel="nofollow" title="Frederik Ramm has selected this answer as the correct answer">
</a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>I figured out the mistake. The map was exported in ESPG:4326 and I wasn't converting the box to this type of coordinates. I used mapnik.ProjTransform and now it works fine.</p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/54621/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>13 Feb '17, 15:12</strong>
</p>
<img alt="biliuta's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/9a081afc9d2ea8fa735de1b5c393f1b5?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/13323/biliuta">biliuta</a><br/>
<span class="score" title="36 reputation points">36</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="biliuta has one accepted answer">100%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-54621">
</div>
<div class="comment-tools" id="comment-tools-54621">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-54621-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<div class="paginator-container-left">
</div>
<form action="/questions/54587/answer/" id="fmanswer" method="post">
<input name="csrfmiddlewaretoken" type="hidden" value="7DiTEbOCS2A1LzilPQ0CCudSDUU611uk"/>
<div style="clear:both">
</div>
</form>
</div>
</div>
</div>