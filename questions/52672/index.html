<meta charset="utf-8"/><link href="../style.css" rel="stylesheet" type="text/css"/><div id="CALeft"><center><a href="../"><img id="ll" src="https://help.openstreetmap.org/upfiles/osm_help_logo_6.png"/></a></center>
<div class="headNormal">
<h1><a href="/questions/52672/osm2pgsql-import-disk-space-running-out-during-index-creation">osm2pgsql import - disk space running out during index creation</a></h1>
</div>
<div class="" id="main-body">
<div id="askform">
<table id="question-table" style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/52672/up/" id="post-52672-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-52672-score" title="current number of votes">
    0
</div>
<a class="ajax-command post-vote down" href="/vote/52672/down/" id="post-52672-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="ajax-command favorite-mark" href="/mark_favorite/52672/" id="favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </a>
<div class="favorite-count" id="favorite-count">
</div>
</div>
</td>
<td>
<div id="item-right">
<div class="question-body">
<p>When I am trying to import a Europe pbf file with osm2pgsql, my diskspace keeps running full during the index creation. </p>
<p>After the import of nodes, ways and relations the tablespace of the database has a size of 233 GB and there is still 244GB disk space available. But during index creation, these 244GB are completely used up. When I imported a europe data set one year ago, the disk space was enough for the database + the prerendered tiles.</p>
<p>Any suggestions as to why the index creation might use up so much disk space this time? Is this normal?</p>
<p>I'm using the following <strong>import command</strong>:</p>
<pre><code>nohup osm2pgsql ~/osm/europe-latest.osm.pbf --create --slim --database gis --number-processes=4 --cache=22000 --multi-geometry --flat-nodes ~/osm/flat-nodes.bin
</code></pre>
<p>And the following <strong>postgres config</strong>:</p>
<pre><code>shared_buffers 8 MB
work_mem 1 MB
maintenance_work_mem 4096 MB
fsync off
autovacuum off
checkpoint_segments 60
</code></pre>
<p>My Stack: Mod_tile, renderd, mapnik, osm2pgsql and a postgresql/postgis database.</p>
<p>Maybe it's worth mentioning that the system has 4CPU and 16GB RAM, with another 16GB of SWAP space.</p>
<p>This is the <strong>error message</strong> in the log file:</p>
<pre><code>Creating geometry index on  planet_osm_polygon
pthread_join() returned exception: Throw location unknown (consider using BOOST_THROW_EXCEPTION)
Dynamic exception type: boost::exception_detail::clone_impl&lt;boost::exception_detail::current_exception_std_exception_wrapper&lt;std::runtime_error&gt; &gt;
std::exception::what: CREATE INDEX planet_osm_polygon_index ON planet_osm_polygon USING GIST (way)   failed: ERROR:  could not extend file "base/16385/8687919.15": No space left on device
HINT:  Check free disk space.
St13runtime_error
Error occurred, cleaning up
</code></pre>
</div>
<div class="tags-container tags" id="question-tags">
<a class="post-tag tag-link-import" href="/tags/import/" rel="tag" title="see questions tagged 'import'">import</a>
<a class="post-tag tag-link-index" href="/tags/index/" rel="tag" title="see questions tagged 'index'">index</a>
<a class="post-tag tag-link-osm2pgsql" href="/tags/osm2pgsql/" rel="tag" title="see questions tagged 'osm2pgsql'">osm2pgsql</a>
<a class="post-tag tag-link-disk_usage" href="/tags/disk_usage/" rel="tag" title="see questions tagged 'disk_usage'">disk_usage</a>
</div>
<div class="post-controls" id="question-controls">
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        asked
        <strong>25 Oct '16, 09:58</strong>
</p>
<img alt="cosmo42's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/0c518db7e694b9e6d2b7f092621a3d4d?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/12910/cosmo42">cosmo42</a><br/>
<span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">●</span><span class="badgecount">2</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="cosmo42 has no accepted answers">0%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-52672">
</div>
<div class="comment-tools" id="comment-tools-52672">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-52672-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
<hr/>
<div class="tabBar">
<a name="sort-top"></a>
<div class="headQuestions">
                    2 Answers:
                    </div>
<div class="tabsA"><a href="/questions/52672/osm2pgsql-import-disk-space-running-out-during-index-creation?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/52672/osm2pgsql-import-disk-space-running-out-during-index-creation?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/52672/osm2pgsql-import-disk-space-running-out-during-index-creation?sort=newest" title="newest answers will be shown first">newest answers</a><a class="on" href="/questions/52672/osm2pgsql-import-disk-space-running-out-during-index-creation?sort=votes" title="most voted answers will be shown first">popular answers</a></div>
</div>
<a name="52673"></a>
<div class="answer" id="answer-container-52673">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/52673/up/" id="post-52673-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-52673-score" title="current number of votes">
    1
</div>
<a class="ajax-command post-vote down" href="/vote/52673/down/" id="post-52673-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>The total disk space used by all indexes on an Europe import should be about 150 GB but I can't say how much space might be temporarily used in addition to that. If you don't need the capability to update your data with incremental updates, add the <code>--drop</code> flag to avoid building unnecessary indexes. </p>
<p>You could also create your PostGIS tablespace on a compressed ZFS volume which will not only give you about twice the storage space but in all likelihood even speed up database operations. See <a href="http://www.paulnorman.ca/blog/2014/11/zfs-settings-for-osm2pgsql/">http://www.paulnorman.ca/blog/2014/11/zfs-settings-for-osm2pgsql/</a> for examples.</p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/52673/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>25 Oct '16, 11:24</strong>
</p>
<img alt="Frederik%20Ramm's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/a2b38d937e70ab39d895d17da0dd1ba4?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/104/frederik-ramm">Frederik Ramm ♦</a><br/>
<span class="score" title="82494 reputation points"><span class="">82.5k</span></span><span title="92 badges"><span class="badge1">●</span><span class="badgecount">92</span></span><span title="720 badges"><span class="silver">●</span><span class="badgecount">720</span></span><span title="1273 badges"><span class="bronze">●</span><span class="badgecount">1273</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="Frederik Ramm has 417 accepted answers">23%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-52673">
<a name="52707"></a>
<div class="comment" id="comment-52707">
<div class="comment-score" id="post-52707-score"></div>
<div class="comment-text"><p>Thanks for the hint. Unfortunately I need to run updates later. 
Could it have an effect that autvacuum ist turned off?</p></div>
<div class="comment-info" id="comment-52707-info">
<span class="comment-age">(27 Oct '16, 08:11)</span>
<a class="comment-user userinfo" href="/users/12910/cosmo42">cosmo42</a>
</div>
</div>
<a name="52710"></a>
<div class="comment" id="comment-52710">
<div class="comment-score" id="post-52710-score"></div>
<div class="comment-text"><p>No, autovacuum turned off should only be a problem for updates to an existing database, not for the initial import.</p></div>
<div class="comment-info" id="comment-52710-info">
<span class="comment-age">(27 Oct '16, 08:28)</span>
<a class="comment-user userinfo" href="/users/104/frederik-ramm">Frederik Ramm ♦</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-52673">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-52673-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<a name="52808"></a>
<div class="answer answered-by-owner" id="answer-container-52808">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/52808/up/" id="post-52808-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-52808-score" title="current number of votes">
    0
</div>
<a class="ajax-command post-vote down" href="/vote/52808/down/" id="post-52808-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>Turning on autovacuum did the trick for me.
During index creation 204 GB were used (instead of completely using up the 244 GB of left disk space). The indexes now take up about 131 GB.</p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/52808/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>03 Nov '16, 09:14</strong>
</p>
<img alt="cosmo42's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/0c518db7e694b9e6d2b7f092621a3d4d?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/12910/cosmo42">cosmo42</a><br/>
<span class="score" title="11 reputation points">11</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">●</span><span class="badgecount">2</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="cosmo42 has no accepted answers">0%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-52808">
<a name="52809"></a>
<div class="comment" id="comment-52809">
<div class="comment-score" id="post-52809-score"></div>
<div class="comment-text"><p>Since most guides for tuning of OSM postgres configs state that autovacuum should be turned off, I think it is worth mentioning that autovacuum could be necessary if disk space is scarce. Also I found no drawbacks in speed with autovacuum turned on - actually the overall import time was a bit faster.</p></div>
<div class="comment-info" id="comment-52809-info">
<span class="comment-age">(03 Nov '16, 09:23)</span>
<a class="comment-user userinfo" href="/users/12910/cosmo42">cosmo42</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-52808">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-52808-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<div class="paginator-container-left">
</div>
<form action="/questions/52672/answer/" id="fmanswer" method="post">
<input name="csrfmiddlewaretoken" type="hidden" value="xAPuGwab0am5pYMJ4A2bq2vOy2Xv0w6z"/>
<div style="clear:both">
</div>
</form>
</div>
</div>
</div>