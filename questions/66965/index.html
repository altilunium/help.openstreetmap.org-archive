<meta charset="utf-8"/><link href="../style.css" rel="stylesheet" type="text/css"/><div id="CALeft"><center><a href="../"><img id="ll" src="https://help.openstreetmap.org/upfiles/osm_help_logo_6.png"/></a></center>
<div class="headNormal">
<h1><a href="/questions/66965/history-of-relations-addedremoved-from-entities">History of relations added/removed from entities</a></h1>
</div>
<div class="" id="main-body">
<div id="askform">
<table id="question-table" style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/66965/up/" id="post-66965-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-66965-score" title="current number of votes">
    2
</div>
<a class="ajax-command post-vote down" href="/vote/66965/down/" id="post-66965-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="ajax-command favorite-mark" href="/mark_favorite/66965/" id="favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </a>
<div class="favorite-count" id="favorite-count">
</div>
</div>
</td>
<td>
<div id="item-right">
<div class="question-body">
<p>Hi
Is there a history recorder that shows when relations were added/removed from entities?</p>
<p>Neither the main page history option of Deep History store such info. </p>
</div>
<div class="tags-container tags" id="question-tags">
<a class="post-tag tag-link-relations" href="/tags/relations/" rel="tag" title="see questions tagged 'relations'">relations</a>
<a class="post-tag tag-link-history" href="/tags/history/" rel="tag" title="see questions tagged 'history'">history</a>
</div>
<div class="post-controls" id="question-controls">
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        asked
        <strong>28 Nov '18, 14:58</strong>
</p>
<img alt="DaveF's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/c9c8b421ad22f51ddd62f23413717036?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/1532/davef">DaveF</a><br/>
<span class="score" title="3264 reputation points"><span class="">3.3k</span></span><span title="84 badges"><span class="badge1">●</span><span class="badgecount">84</span></span><span title="98 badges"><span class="silver">●</span><span class="badgecount">98</span></span><span title="133 badges"><span class="bronze">●</span><span class="badgecount">133</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="DaveF has 17 accepted answers">16%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-66965">
<a name="66970"></a>
<div class="comment" id="comment-66970">
<div class="comment-score" id="post-66970-score"></div>
<div class="comment-text"><p>The history display on the openstreetmap.org site should show changes to the members of relations, regardless of whether those members were relations or not. Can you give an example where this isn't the case?</p></div>
<div class="comment-info" id="comment-66970-info">
<span class="comment-age">(28 Nov '18, 17:11)</span>
<a class="comment-user userinfo" href="/users/8189/alester">alester</a>
</div>
</div>
<a name="66971"></a>
<div class="comment" id="comment-66971">
<div class="comment-score" id="post-66971-score"></div>
<div class="comment-text"><p>I was thinking of a way/node where I want to know if any relation (not a specific one where the ID is known) has been removed. 
History of ways/nodes on openstreetmap.org only list the current relations added to the latest edit.</p></div>
<div class="comment-info" id="comment-66971-info">
<span class="comment-age">(28 Nov '18, 17:51)</span>
<a class="comment-user userinfo" href="/users/1532/davef">DaveF</a>
</div>
</div>
<a name="66977"></a>
<div class="comment" id="comment-66977">
<div class="comment-score" id="post-66977-score"></div>
<div class="comment-text"><p>Oh okay, I thought you were asking about changes to the membership of relations, not the other way around. I'm not sure about any history that shows whether an object has been a member of a relation.</p></div>
<div class="comment-info" id="comment-66977-info">
<span class="comment-age">(28 Nov '18, 19:29)</span>
<a class="comment-user userinfo" href="/users/8189/alester">alester</a>
</div>
</div>
<a name="66981"></a>
<div class="comment" id="comment-66981">
<div class="comment-score" id="post-66981-score"></div>
<div class="comment-text"><p>It'd be very difficult to detect - a changeset that removed a way from a relation would have only the new ways of the relation in it, not the old way.</p></div>
<div class="comment-info" id="comment-66981-info">
<span class="comment-age">(28 Nov '18, 23:35)</span>
<a class="comment-user userinfo" href="/users/387/someoneelse">SomeoneElse ♦</a>
</div>
</div>
<a name="66989"></a>
<div class="comment" id="comment-66989">
<div class="comment-score" id="post-66989-score">1</div>
<div class="comment-text"><p>Do you have an example (way/node id)? Do you have a specific use-case or question in mind?</p></div>
<div class="comment-info" id="comment-66989-info">
<span class="comment-age">(29 Nov '18, 16:10)</span>
<a class="comment-user userinfo" href="/users/2012/ikonor">ikonor</a>
</div>
</div>
<a name="67015"></a>
<div class="comment not_top_scorer" id="comment-67015">
<div class="comment-score" id="post-67015-score"></div>
<div class="comment-text"><p>I don't have an example precisely because of this problem. I don't know whether the node/way entities previously had relations attached or not. That's what I want to discover.</p></div>
<div class="comment-info" id="comment-67015-info">
<span class="comment-age">(30 Nov '18, 18:57)</span>
<a class="comment-user userinfo" href="/users/1532/davef">DaveF</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-66965">
<span class="comments-showing">
            showing 5 of 6
        </span>
<a class="show-all-comments-link" href="#">show 1 more comments</a>
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-66965-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
<hr/>
<div class="tabBar">
<a name="sort-top"></a>
<div class="headQuestions">
                    3 Answers:
                    </div>
<div class="tabsA"><a href="/questions/66965/history-of-relations-addedremoved-from-entities?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/66965/history-of-relations-addedremoved-from-entities?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/66965/history-of-relations-addedremoved-from-entities?sort=newest" title="newest answers will be shown first">newest answers</a><a class="on" href="/questions/66965/history-of-relations-addedremoved-from-entities?sort=votes" title="most voted answers will be shown first">popular answers</a></div>
</div>
<a name="67002"></a>
<div class="answer" id="answer-container-67002">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/67002/up/" id="post-67002-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-67002-score" title="current number of votes">
    2
</div>
<a class="ajax-command post-vote down" href="/vote/67002/down/" id="post-67002-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>I'm also not aware of any tool that would show relation membership history for an entity. Tools like Deep History use the <a href="https://wiki.openstreetmap.org/wiki/API_v0.6">OSM API</a>, but there is just the <a href="https://wiki.openstreetmap.org/wiki/API_v0.6#Relations_for_element:_GET_.2Fapi.2F0.6.2F.5Bnode.7Cway.7Crelation.5D.2F.23id.2Frelations">relations</a> call that returns the current state only.</p>
<p>What the Overpass API can do, is getting relation memberships at a certain time in the past with the <a href="https://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL#date">date</a> setting and a <a href="https://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL#Recurse_up_.28.3C.29">recurse up (&lt;)</a>:</p>
<pre><code>[date:"2018-11-01T00:00:00Z"];
(
  way(id:228444126);
  &lt;;
);
out meta geom;
</code></pre>
<p><a href="http://overpass-turbo.eu/s/E9o">Overpass Turbo</a></p>
<p>This query returns two multipolygon relations <a href="https://www.openstreetmap.org/way/228444126">way 228444126</a> was part of at the time (currently none).</p>
<p>You can also get the diff between two timestamps (or one timestamp and current state) with the <a href="https://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL#Augmented_Delta_between_two_dates_.28.22adiff.22.29">adiff</a> setting, e.g.:</p>
<pre><code>[adiff:"2018-11-01T00:00:00Z"];
way(id:228444126);
&lt;;
out tags;
</code></pre>
<p><a href="http://overpass-turbo.eu/s/E9r">Overpass Turbo</a></p>
<p>The result is in the special <a href="https://wiki.openstreetmap.org/wiki/Overpass_API/Augmented_Diffs#Contained_data">Augmented Diff</a> format (using "out tags" for brevity here).</p>
<pre><code>&lt;action type="delete"&gt;
&lt;old&gt;
  &lt;relation id="2274470"&gt;
    &lt;tag k="landuse" v="residential"/&gt;
    &lt;tag k="type" v="multipolygon"/&gt;
  &lt;/relation&gt;
&lt;/old&gt;
&lt;new&gt;
  &lt;relation id="2274470" visible="true"/&gt;
&lt;/new&gt;
&lt;/action&gt;
&lt;action type="delete"&gt;
&lt;old&gt;
  &lt;relation id="3059784"&gt;
    &lt;tag k="landuse" v="meadow"/&gt;
    &lt;tag k="type" v="multipolygon"/&gt;
  &lt;/relation&gt;
&lt;/old&gt;
&lt;new&gt;
  &lt;relation id="3059784" visible="false"/&gt;
&lt;/new&gt;
&lt;/action&gt;
</code></pre>
<p>The actions refer to the diff between two query results at the given timestamps. So action "delete" in our context means, that two relations were found in the past but not for the current state, i.e. the way is no longer member of those two relations. The visible flag indicates that the second meadow relation was actually deleted.</p>
<p>Limitations:</p>
<ul>
<li>net neutral changes within the given time range won't appear in the diff, e.g. if an entity was added to a relation and later removed again. Therefore searching for when an entity was removed from which relation requires knowing or figuring out a date when the entity was still a member of that relation.</li>
<li>attic data is only available since 2012-09-12T06:55:00Z</li>
</ul>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/67002/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>30 Nov '18, 11:56</strong>
</p>
<img alt="ikonor's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/f92748c8fa508a936bcf2169b30cabf6?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/2012/ikonor">ikonor</a><br/>
<span class="score" title="1286 reputation points"><span class="">1.3k</span></span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="11 badges"><span class="silver">●</span><span class="badgecount">11</span></span><span title="19 badges"><span class="bronze">●</span><span class="badgecount">19</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="ikonor has 4 accepted answers">18%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-67002">
</div>
<div class="comment-tools" id="comment-tools-67002">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-67002-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<a name="67035"></a>
<div class="answer" id="answer-container-67035">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/67035/up/" id="post-67035-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-67035-score" title="current number of votes">
    1
</div>
<a class="ajax-command post-vote down" href="/vote/67035/down/" id="post-67035-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>Another approach is using the <a href="https://wiki.openstreetmap.org/wiki/Planet.osm/full">full history planet</a> with the <a href="https://osmcode.org/osmium-tool/">Osmium Tool</a> <a href="https://osmcode.org/opl-file-format/">OPL (Object Per Line) file format</a> and UNIX command line tools. This is a bit more involved, but allows to retrieve the complete membership history.</p>
<p>Geofabrik provides <a href="https://osm-internal.download.geofabrik.de/index.html">full history extracts</a> (.osh.pbf). For our example we download <a href="https://osm-internal.download.geofabrik.de/europe/germany/bayern/oberbayern.html">oberbayern-internal.osh.pbf</a>. On the command line we further extract a bounding box for the area of interest and output as OPL format (.opl):</p>
<pre><code>osmium extract --with-history --bbox 11.751,48.0832,11.8147,48.1226 -o vaterstetten.osh.opl oberbayern-internal.osh.pbf
</code></pre>
<p>Then we can filter for relations with the given entity in the members list using "grep". The "sed" formats the matching lines to print relation meta data and the entity member role:</p>
<pre><code>ENTITY=w228444126; grep -A1 -e "^r.* M.*$ENTITY@.*" vaterstetten.osh.opl | \
  sed -e "s/^\(r.*\) i.* M.*$ENTITY@\([^,]*\).*/\1 \2/" -e "s/^\(r.*\) i.* M.*/\1 -/"
</code></pre>
<p>The output for <a href="https://www.openstreetmap.org/way/228444126">way 228444126</a>:</p>
<pre><code>r2274470 v2 dV c16797536 t2013-07-02T20:43:57Z outer
r2274470 v3 dV c17398391 t2013-08-18T16:10:31Z outer
r2274470 v4 dV c64490423 t2018-11-14T16:11:18Z outer
r2274470 v5 dV c64492155 t2018-11-14T16:46:54Z -
--
r3059784 v1 dV c16797536 t2013-07-02T20:43:57Z outer
r3059784 v2 dD c64492155 t2018-11-14T16:46:54Z -
</code></pre>
<p>OSM files are usually ordered by type, id, version. The grep "-A1" option also prints the next line after a match or a group of consecutive matches. If that extra line is the next version of the same relation, then the entity has been removed as member, or the relation deleted ("dD"). Otherwise, if the extra line is a different relation, then the last matching version is the current and the entity still a member. The last sed expression marks those extra lines where the entity is not a member with a hyphen ("-"). </p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/67035/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>02 Dec '18, 09:43</strong>
</p>
<img alt="ikonor's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/f92748c8fa508a936bcf2169b30cabf6?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/2012/ikonor">ikonor</a><br/>
<span class="score" title="1286 reputation points"><span class="">1.3k</span></span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="11 badges"><span class="silver">●</span><span class="badgecount">11</span></span><span title="19 badges"><span class="bronze">●</span><span class="badgecount">19</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="ikonor has 4 accepted answers">18%</span>
</p>
</div>
<div class="post-update-info post-update-info-edited">
<p style="line-height:12px;">
<a href="/revisions/67035/">
                edited
                <strong>02 Dec '18, 09:45</strong>
</a>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-67035">
</div>
<div class="comment-tools" id="comment-tools-67035">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-67035-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<a name="78428"></a>
<div class="answer" id="answer-container-78428">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/78428/up/" id="post-78428-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-78428-score" title="current number of votes">
    -2
</div>
<a class="ajax-command post-vote down" href="/vote/78428/down/" id="post-78428-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>Just paste relation id to the following path: <br/>
<a href="http://osm.mapki.com/history/relation.php?id=">http://osm.mapki.com/history/relation.php?id=</a></p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/78428/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>21 Jan '21, 09:16</strong>
</p>
<img alt="Cascafico's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/d33efa30f05d8f3604e7210c48b24a8b?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/853/cascafico">Cascafico</a><br/>
<span class="score" title="283 reputation points">283</span><span title="20 badges"><span class="badge1">●</span><span class="badgecount">20</span></span><span title="23 badges"><span class="silver">●</span><span class="badgecount">23</span></span><span title="29 badges"><span class="bronze">●</span><span class="badgecount">29</span></span><br>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="Cascafico has no accepted answers">0%</span>
</br></p>
</div>
</div>
<div class="comments-container" id="comments-container-78428">
<a name="78429"></a>
<div class="comment" id="comment-78429">
<div class="comment-score" id="post-78429-score"></div>
<div class="comment-text"><p>The OP was searching for relations that had a specific node or way as member at some point in the past. T</p></div>
<div class="comment-info" id="comment-78429-info">
<span class="comment-age">(21 Jan '21, 09:45)</span>
<a class="comment-user userinfo" href="/users/10133/tzorn">TZorn</a>
</div>
</div>
<a name="78433"></a>
<div class="comment" id="comment-78433">
<div class="comment-score" id="post-78433-score"></div>
<div class="comment-text"><p>ok, sorry I've been too short: </p>
<p>in the result page, just search for element ID and you get the membership in's and out's in all the relation versions.</p></div>
<div class="comment-info" id="comment-78433-info">
<span class="comment-age">(21 Jan '21, 11:18)</span>
<a class="comment-user userinfo" href="/users/853/cascafico">Cascafico</a>
</div>
</div>
<a name="78442"></a>
<div class="comment" id="comment-78442">
<div class="comment-score" id="post-78442-score"></div>
<div class="comment-text"><p>The relation id is unknown, question comment quote:</p>
<blockquote>
<p>I was thinking of a way/node where I want to know if any relation (not a specific one where the ID is known) has been removed.</p>
</blockquote></div>
<div class="comment-info" id="comment-78442-info">
<span class="comment-age">(21 Jan '21, 15:27)</span>
<a class="comment-user userinfo" href="/users/2012/ikonor">ikonor</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-78428">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-78428-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<div class="paginator-container-left">
</div>
<form action="/questions/66965/answer/" id="fmanswer" method="post">
<input name="csrfmiddlewaretoken" type="hidden" value="DNYHSFhUs5EiZJMa4TifxRwGAsbaR5dI"/>
<div style="clear:both">
</div>
</form>
</div>
</div>
</div>