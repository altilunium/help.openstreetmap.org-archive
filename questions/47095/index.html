<meta charset="utf-8"/><link href="../style.css" rel="stylesheet" type="text/css"/><div id="CALeft"><center><a href="../"><img id="ll" src="https://help.openstreetmap.org/upfiles/osm_help_logo_6.png"/></a></center>
<div class="headNormal">
<h1><a href="/questions/47095/speed-up-overpass-queries-via-local-osm-copy-and-osmosis-pre-filtering">Speed up Overpass Queries via Local OSM Copy and Osmosis pre-filtering?</a></h1>
</div>
<div class="" id="main-body">
<div id="askform">
<table id="question-table" style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/47095/up/" id="post-47095-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-47095-score" title="current number of votes">
    1
</div>
<a class="ajax-command post-vote down" href="/vote/47095/down/" id="post-47095-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="ajax-command favorite-mark" href="/mark_favorite/47095/" id="favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </a>
<div class="favorite-count" id="favorite-count">
   1
</div>
</div>
</td>
<td>
<div id="item-right">
<div class="question-body">
<p>I am using Overpass API (on overpass-api.de) to query for transport-related elements along a recorded GPS track/journey. Currently, I perform several "around"-queries for each track point of the journey to get the IDs of e.g. public transport routes and stops, roads, railway etc. within 50m. This takes a few seconds for each track point, and since each journey consists of about 100 track points, collecting all data takes minutes instead of desired &lt;10s.</p>
<p>I have the following idea for optimizing this:</p>
<ul>
<li>create a local copy of planet.osm <strike>and Overpass API</strike> on my own server.  --&gt; no sharing of server-load</li>
<li>use Osmosis to pre-filter planet.osm for only the transport-related elements I am looking for --&gt; <strike>Overpass</strike> only has to search a smaller database.</li>
</ul>
<p>Since I am not experienced with OSM and this requires considerable effort:</p>
<ul>
<li><strong>Are my assumptions correct and do they make sense?</strong></li>
<li><strong>Can I expect a significant speed-up from this?</strong></li>
</ul>
<p>Thanks in advance!</p>
<p>Arik</p>
</div>
<div class="tags-container tags" id="question-tags">
<a class="post-tag tag-link-overpass" href="/tags/overpass/" rel="tag" title="see questions tagged 'overpass'">overpass</a>
<a class="post-tag tag-link-optimization" href="/tags/optimization/" rel="tag" title="see questions tagged 'optimization'">optimization</a>
<a class="post-tag tag-link-osmosis" href="/tags/osmosis/" rel="tag" title="see questions tagged 'osmosis'">osmosis</a>
</div>
<div class="post-controls" id="question-controls">
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        asked
        <strong>11 Dec '15, 13:35</strong>
</p>
<img alt="Arik's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/382c1236163ab7156d672328538ba11e?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/11756/arik">Arik</a><br/>
<span class="score" title="51 reputation points">51</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="2 badges"><span class="silver">●</span><span class="badgecount">2</span></span><span title="5 badges"><span class="bronze">●</span><span class="badgecount">5</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="Arik has no accepted answers">0%</span>
</p>
</div>
<div class="post-update-info post-update-info-edited">
<p style="line-height:12px;">
<a href="/revisions/47095/">
                edited
                <strong>11 Dec '15, 15:38</strong>
</a>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-47095">
<a name="47098"></a>
<div class="comment" id="comment-47098">
<div class="comment-score" id="post-47098-score">2</div>
<div class="comment-text"><p>Is there any reason you particularly want to use Overpass locally? Simple PostGIS queries should be able to do this if you load OSM data into a spatial database using the standard tools.</p></div>
<div class="comment-info" id="comment-47098-info">
<span class="comment-age">(11 Dec '15, 15:00)</span>
<a class="comment-user userinfo" href="/users/5/richard">Richard ♦</a>
</div>
</div>
<a name="47099"></a>
<div class="comment" id="comment-47099">
<div class="comment-score" id="post-47099-score"></div>
<div class="comment-text"><p>Thanks for your comment! I was actually not aware of the fact that there is a different way to access the data. 
So, let's forget about Overpass in my question... I'll read about PostGIS to query a local database.
Now, does the assumption with the prefiltering make sense?</p></div>
<div class="comment-info" id="comment-47099-info">
<span class="comment-age">(11 Dec '15, 15:11)</span>
<a class="comment-user userinfo" href="/users/11756/arik">Arik</a>
</div>
</div>
<a name="47100"></a>
<div class="comment not_top_scorer" id="comment-47100">
<div class="comment-score" id="post-47100-score"></div>
<div class="comment-text"><p><a href="http://help.openstreetmap.org/users/11756/arik">@Arik</a> Would it be possible to describe the sort of queries that you might want to do?  Not in query language - just at the level of "I want to find houses near a road called X" or similar.</p></div>
<div class="comment-info" id="comment-47100-info">
<span class="comment-age">(11 Dec '15, 15:14)</span>
<a class="comment-user userinfo" href="/users/387/someoneelse">SomeoneElse ♦</a>
</div>
</div>
<a name="47101"></a>
<div class="comment" id="comment-47101">
<div class="comment-score" id="post-47101-score">1</div>
<div class="comment-text"><p>Sure, for example: I want to know whether there is at least one road within 50m around given coordinates. Then replace "road" with several other elements like "bus stop", "train station", "subway route" and query again.
For routes, the ID of the relation would be useful as well.</p>
<p>P.S.: more generally, my goal is to find out what means of transport could have been used while recording the GPS track</p></div>
<div class="comment-info" id="comment-47101-info">
<span class="comment-age">(11 Dec '15, 15:34)</span>
<a class="comment-user userinfo" href="/users/11756/arik">Arik</a>
</div>
</div>
<a name="47106"></a>
<div class="comment not_top_scorer" id="comment-47106">
<div class="comment-score" id="post-47106-score"></div>
<div class="comment-text"><p>Can you please post your original Overpass Query as overpass turbo link, so we can check if the issue persists with the latest beta version. Thanks.</p></div>
<div class="comment-info" id="comment-47106-info">
<span class="comment-age">(11 Dec '15, 17:20)</span>
<a class="comment-user userinfo" href="/users/8708/mmd">mmd</a>
</div>
</div>
<a name="47108"></a>
<div class="comment not_top_scorer" id="comment-47108">
<div class="comment-score" id="post-47108-score"></div>
<div class="comment-text"><p>It is not an issue with Overpass, I guess. Querying a lot of elements just takes its time.
Instead, I will use PostGIS as suggested by Richard, I guess. The only remaining question is whether it makes sense to create a reduced dataset first which only includes all transport-related elements. I would strongly guess that the answer is yes and would be happy for a confirmation by an experienced user before I waste my time setting everything up.</p></div>
<div class="comment-info" id="comment-47108-info">
<span class="comment-age">(11 Dec '15, 17:47)</span>
<a class="comment-user userinfo" href="/users/11756/arik">Arik</a>
</div>
</div>
<a name="47109"></a>
<div class="comment" id="comment-47109">
<div class="comment-score" id="post-47109-score">1</div>
<div class="comment-text"><p>You mentioned a response time of several seconds. In the current beta, I would expect sub-second response time. I'm just asking to confirm that it's no longer an issue.</p>
<p>How much the savings of a reduced data set are in reality is hard to tell without running some tests. Biggest issue being: setting up a full planet db for comparison - that may easily take a few days. In any case I recommend to start out with some small extract (from download.geofabrik.de) and get familiar with the toolchain.</p></div>
<div class="comment-info" id="comment-47109-info">
<span class="comment-age">(11 Dec '15, 17:50)</span>
<a class="comment-user userinfo" href="/users/8708/mmd">mmd</a>
</div>
</div>
<a name="47110"></a>
<div class="comment not_top_scorer" id="comment-47110">
<div class="comment-score" id="post-47110-score"></div>
<div class="comment-text"><p>Okay, sure, so below you find the link to an example. I use the regex because I experienced it to be significantly faster than using the union of the queries of all the key-value pairs. And you're right, it takes about one second. I recently also tried to get all the nodes belonging to the elements (see the part that is commented out), which takes longer.</p>
<p><a href="http://overpass-turbo.eu/s/ddY">http://overpass-turbo.eu/s/ddY</a></p></div>
<div class="comment-info" id="comment-47110-info">
<span class="comment-age">(11 Dec '15, 18:10)</span>
<a class="comment-user userinfo" href="/users/11756/arik">Arik</a>
</div>
</div>
<a name="47111"></a>
<div class="comment" id="comment-47111">
<div class="comment-score" id="post-47111-score">1</div>
<div class="comment-text"><p>ok, thanks! On the dev instance I get 880ms response time for the official 0.7.52 version and about 550ms on the beta (running with <code>osm3s_query</code>, data in buffer cache). Response times on overpass-api.de are higher due to overall higher CPU utilization there. overpass-api.de only accepts one query at a time, but rambler.ru instance doesn't have that limit. If you set up your own instance, you can of course run as many queries in parallel as you wish (or your hardware can handle).</p></div>
<div class="comment-info" id="comment-47111-info">
<span class="comment-age">(11 Dec '15, 18:28)</span>
<a class="comment-user userinfo" href="/users/8708/mmd">mmd</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-47095">
<span class="comments-showing">
            showing 5 of 9
        </span>
<a class="show-all-comments-link" href="#">show 4 more comments</a>
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-47095-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
<hr/>
<div class="tabBar">
<a name="sort-top"></a>
<div class="headQuestions">
                    One Answer:
                    </div>
<div class="tabsA"><a href="/questions/47095/speed-up-overpass-queries-via-local-osm-copy-and-osmosis-pre-filtering?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/47095/speed-up-overpass-queries-via-local-osm-copy-and-osmosis-pre-filtering?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/47095/speed-up-overpass-queries-via-local-osm-copy-and-osmosis-pre-filtering?sort=newest" title="newest answers will be shown first">newest answers</a><a class="on" href="/questions/47095/speed-up-overpass-queries-via-local-osm-copy-and-osmosis-pre-filtering?sort=votes" title="most voted answers will be shown first">popular answers</a></div>
</div>
<a name="47118"></a>
<div class="answer accepted-answer" id="answer-container-47118">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/47118/up/" id="post-47118-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-47118-score" title="current number of votes">
    3
</div>
<a class="ajax-command post-vote down" href="/vote/47118/down/" id="post-47118-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="accept-answer on" href="/accept_answer/47118/" rel="nofollow" title="Arik has selected this answer as the correct answer">
</a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>A smaller database for Overpass API would indeed help to speed things up a bit:</p>
<p>Here's a small comparison I ran for your sample query <a href="http://overpass-turbo.eu/s/ddY">http://overpass-turbo.eu/s/ddY</a></p>
<ul>
<li>Full planet on v0.7.52 (official) - 880ms</li>
<li>Full Planet on <a href="https://github.com/mmd-osm/Overpass-API/wiki/Overpass-API-test754">v0.7.54_mmd (beta)</a> - 550ms</li>
</ul>
<p>Now comparing that with a smaller Berlin extract provided by Geofabrik and various database compression settings (lz4, gzip or no compression):</p>
<ul>
<li><a href="http://download.geofabrik.de/europe/germany/berlin.html">Berlin-only extract</a> on <a href="https://github.com/mmd-osm/Overpass-API/wiki/Overpass-API-test754">v0.7.54_mmd (beta)</a>, lz4 - 140ms (default for this branch)</li>
<li><a href="http://download.geofabrik.de/europe/germany/berlin.html">Berlin-only extract</a> on <a href="https://github.com/mmd-osm/Overpass-API/wiki/Overpass-API-test754">v0.7.54_mmd (beta)</a>, gzip  - 250ms (also default in v0.7.52)</li>
<li><a href="http://download.geofabrik.de/europe/germany/berlin.html">Berlin-only extract</a> on <a href="https://github.com/mmd-osm/Overpass-API/wiki/Overpass-API-test754">v0.7.54_mmd (beta)</a>, no compression - 100ms (also default in v0.7.51)</li>
</ul>
<p>Database was populated using:</p>
<pre><code>osmconvert berlin-latest.osm.pbf --out-osm | ./update_database --db-dir=~/berlin --meta
</code></pre>
<p>or with one of the following compression settings:</p>
<pre><code>    osmconvert berlin-latest.osm.pbf --out-osm | ./update_database --db-dir=~/berlin --meta --compression_method=gz

    osmconvert berlin-latest.osm.pbf --out-osm | ./update_database --db-dir=~/berlin --meta --compression_method=no
</code></pre>
<p>Query was run using:</p>
<pre><code>./osm3s_query --db-dir=~/berlin &lt; query
</code></pre>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/47118/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>12 Dec '15, 10:14</strong>
</p>
<img alt="mmd's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/264d84ab05b942224b05960903eba7a7?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/8708/mmd">mmd</a><br/>
<span class="score" title="5682 reputation points"><span class="">5.7k</span></span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="53 badges"><span class="silver">●</span><span class="badgecount">53</span></span><span title="88 badges"><span class="bronze">●</span><span class="badgecount">88</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="mmd has 44 accepted answers">37%</span>
</p>
</div>
<div class="post-update-info post-update-info-edited">
<p style="line-height:12px;">
<a href="/revisions/47118/">
                edited
                <strong>13 Dec '15, 13:12</strong>
</a>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-47118">
<a name="47127"></a>
<div class="comment" id="comment-47127">
<div class="comment-score" id="post-47127-score">1</div>
<div class="comment-text"><p>Thanks for the effort! It's great news that reducing the database to a certain region helps.</p>
<p>In my case, I want to reduce the database by only including the elements in my query (transport-related elements). I guess, this is possible with Osmosis and will speed it up as well.
I'll test it with the Berlin-extract first, thanks for the idea :)</p></div>
<div class="comment-info" id="comment-47127-info">
<span class="comment-age">(13 Dec '15, 11:20)</span>
<a class="comment-user userinfo" href="/users/11756/arik">Arik</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-47118">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-47118-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<div class="paginator-container-left">
</div>
<form action="/questions/47095/answer/" id="fmanswer" method="post">
<input name="csrfmiddlewaretoken" type="hidden" value="W2eFKrgFrLEn4E26oZr6N9uk5jDCoxQh"/>
<div style="clear:both">
</div>
</form>
</div>
</div>
</div>