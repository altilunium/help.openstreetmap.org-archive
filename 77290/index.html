<meta charset="UTF-8"><link rel="stylesheet" type="text/css" href="../style.css"><div id="CALeft">
<div class="headNormal">
<h1><a href="/questions/77290/how-to-extract-only-tags-from-db-without-rest-entities">How to extract only tags from DB without rest entities</a></h1>
</div>
<div class="" id="main-body">
<div id="askform">
<table id="question-table" style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/77290/up/" id="post-77290-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-77290-score" title="current number of votes">
    1
</div>
<a class="ajax-command post-vote down" href="/vote/77290/down/" id="post-77290-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="ajax-command favorite-mark" href="/mark_favorite/77290/" id="favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </a>
<div class="favorite-count" id="favorite-count">
   1
</div>
</div>
</td>
<td>
<div id="item-right">
<div class="question-body">
<p>The problem which I faced is quite complex. I work with OSM editor where I can override some ways properties. Those properties are tags called "maxspeed:backward" and "maxspeed:forward".
Sometimes I want to update my local map with OSM official data (new roads, roads under constructions etc.). <br/>
What I want is to merge my local map with official osm to keep all road and nodes changes from official source but keep my tags with values from editor. I work with Postgres DB, osmosis (merge tool), osmfilter and osmconvert tools.<br/><br/>
This is process which I found out:
<br/>1. Take my local map from editor and filter out only tags. With no nodes, ways, relations.
<br/>2. Take official OSM map and filter out only tags (the same as step 1)
<br/>3. Merge those sources with osmosis with conflictResult strategy - my local tag values override official OSM map.
<br/>4. Again take official OSM map but now I drop tags, so I get full map without tags I'm using.
<br/>5. Merge result from step 3 (correct tags and values) with result from step 4 (official map without tags) with conflictResult strategy - official map nodes override my local.
<br/> <br/>
What I want to achieve is go teg most current map with my own tags.
<br/>I have a problem with step 1. Can I retrieve from DB ONLY tags? Without any nodes or another informations which could override official map in step 5? What I can see in DB tags are placed in separate table and has got reference to whe <code>way_id</code>, so if I merge that values with another source with the same <code>way_id</code>.<br/><br/>
What I try with osmfilter is: <br/>
<code>./osmfilter $EDITED_OSM_NAME --keep-tags="all maxspeed:backward= maxspeed:forward= maxspeed="  -o=$EDITED_OSM_TAGS</code> <br/>
It filter correctly- only listed tags are in output pbf file, but is there any possibility to retreive them without any nodes,ways,relations etc?
<br/>
<br/> I have also tried something with <br/><code>--drop-relations</code>,<code>--drop-ways</code>,<code>--drop-nodes</code>, <code>--ignore-dependencies</code> but it didn't work the way I wish.
<br/><br/>Thank you in advance for help.</p>
</div>
<div class="tags-container tags" id="question-tags">
<a class="post-tag tag-link-filter" href="/tags/filter/" rel="tag" title="see questions tagged 'filter'">filter</a>
<a class="post-tag tag-link-merge" href="/tags/merge/" rel="tag" title="see questions tagged 'merge'">merge</a>
<a class="post-tag tag-link-osmfilter" href="/tags/osmfilter/" rel="tag" title="see questions tagged 'osmfilter'">osmfilter</a>
<a class="post-tag tag-link-osmosis" href="/tags/osmosis/" rel="tag" title="see questions tagged 'osmosis'">osmosis</a>
<a class="post-tag tag-link-tagging" href="/tags/tagging/" rel="tag" title="see questions tagged 'tagging'">tagging</a>
</div>
<div class="post-controls" id="question-controls">
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        asked
        <strong>28 Oct '20, 14:45</strong>
</p>
<img alt="engopy's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/735ed8c1abf1a1f7b907b78d9594303c?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/19203/engopy">engopy</a><br>
<span class="score" title="126 reputation points">126</span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="10 badges"><span class="silver">●</span><span class="badgecount">10</span></span><span title="15 badges"><span class="bronze">●</span><span class="badgecount">15</span></span><br>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="engopy has no accepted answers">0%</span>
</br></br></p>
</div>
<div class="post-update-info post-update-info-edited">
<p style="line-height:12px;">
<a href="/revisions/77290/">
                edited
                <strong>29 Oct '20, 09:20</strong>
</a>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-77290">
</div>
<div class="comment-tools" id="comment-tools-77290">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-77290-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
<hr/>
<div class="tabBar">
<a name="sort-top"></a>
<div class="headQuestions">
                    2 Answers:
                    </div>
<div class="tabsA"><a href="/questions/77290/how-to-extract-only-tags-from-db-without-rest-entities?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/77290/how-to-extract-only-tags-from-db-without-rest-entities?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/77290/how-to-extract-only-tags-from-db-without-rest-entities?sort=newest" title="newest answers will be shown first">newest answers</a><a class="on" href="/questions/77290/how-to-extract-only-tags-from-db-without-rest-entities?sort=votes" title="most voted answers will be shown first">popular answers</a></div>
</div>
<a name="77318"></a>
<div class="answer" id="answer-container-77318">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/77318/up/" id="post-77318-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-77318-score" title="current number of votes">
    0
</div>
<a class="ajax-command post-vote down" href="/vote/77318/down/" id="post-77318-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>Hello! Try to use QGis, I once found instructions in yuotube on how to sort and unload certain tags, try to search, if you can't find it, I'll try to find it then and send it exactly where I saw it.</p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/77318/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>30 Oct '20, 08:26</strong>
</p>
<img alt="Viki_travel_weak's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/0bfd43e5ecd2d06a1e20975a1e024514?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/16848/viki_travel_weak">Viki_travel_...</a><br>
<span class="score" title="1 reputation points">1</span><span title="1 badges"><span class="bronze">●</span><span class="badgecount">1</span></span><br>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="Viki_travel_weak has no accepted answers">0%</span>
</br></br></p>
</div>
</div>
<div class="comments-container" id="comments-container-77318">
</div>
<div class="comment-tools" id="comment-tools-77318">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-77318-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<a name="77393"></a>
<div class="answer answered-by-owner" id="answer-container-77393">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/77393/up/" id="post-77393-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-77393-score" title="current number of votes">
    0
</div>
<a class="ajax-command post-vote down" href="/vote/77393/down/" id="post-77393-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>Maybe my answer will be valuable for anyone who faces the same problem.<br/>
Just to remind, I want to download official OSM map but keep my local informations (in my case <code>maxspeed</code> tags).<br/>
Process which I wrote goes like this:<br/>
1) When my current changes are saved in local OSM editor, than I run my SQL script directly on Postgres database. That script export all tags from <code>maxspeed</code>, <code>maxspedd:forward</code>, <code>maxspeed:backward</code> from <code>way_tags</code> table to the CSV file.</p>
<hr/>
<pre><code>CREATE TABLE IF NOT EXISTS temp_tags (LIKE way_tags);
ALTER TABLE temp_tags 
ADD COLUMN IF NOT EXISTS ah_edited boolean default TRUE;

ALTER TABLE way_tags
ADD COLUMN IF NOT EXISTS ah_edited boolean DEFAULT FALSE;


COPY 
  (SELECT DISTINCT ON(way_id, k)
  way_tags.way_id, way_tags.k, way_tags.v, way_tags.version, way_tags.ah_edited
  FROM way_tags
  JOIN ways ON way_tags.way_id = ways.way_id AND way_tags.version = ways.version
  JOIN changesets on ways.changeset_id=changesets.id
  JOIN users ON changesets.user_id=users.id
  WHERE (k like 'maxspeed:backward'
         OR k like 'maxspeed:forward'
         OR k like 'maxspeed')
  AND ((users.email like '%admin.com%' AND ways.changeset_id != 0)
        OR way_tags.ah_edited = TRUE)
  ORDER BY way_id, k, version desc)  TO STDOUT (format csv, delimiter ';', header false);

ALTER TABLE way_tags
DROP COLUMN IF EXISTS ah_edited;

DROP TABLE IF EXISTS temp_tags;
</code></pre>
<hr/>
<p>As some can notice I use additional column <code>ah_edited</code> just to keep information that information is my edited one and should overwrite the "world" data if exists with the same tag.<br/>
After doing SAVE in OSM editor, in fact we save two copies of the same tags but with different version and incremented <code>changeset_id</code> - that's why I look for tags which has that value !=0, and I use DISTINCT ON function which returns higher version value (after my modifications).<br/>
Thanks to that I got an CSV with my tags which I want to keep in the future downloaded map.<br/><br/>
 2) Truncate DB<br/>
3) Download latest map version from geofabrik.de<br/>
4) Upload map to the database<br/></p>
<p><em>Here lets pause for a moment<br/>Our data we can divide into two groups -&gt; completely new tags for some ways, and already existing in official maps but our values should overwrite them. That's why I divided that process into two parts.</em><br/><br/>
5) Insert new values to the DB
    --  Get table to the original structure</p>
<pre><code>ALTER TABLE way_tags
ADD COLUMN IF NOT EXISTS ah_edited boolean default FALSE;

--  Create temp table from CSV which holds pre-merge changes
CREATE TABLE IF NOT EXISTS temp_tags (LIKE way_tags);

COPY temp_tags(way_id, k, v, version, ah_edited) FROM '/home/map-data/exportedTags.csv'     (FORMAT csv, delimiter ';', header false);

--  Add edidtion column to the way_tags and insert unique values which only AH added

INSERT INTO way_tags (way_id, k, v, version, ah_edited)
SELECT temp_tags.way_id, temp_tags.k, temp_tags.v, w.version, temp_tags.ah_edited  
FROM temp_tags 
FULL JOIN way_tags ON temp_tags.way_id = way_tags.way_id AND temp_tags.k like way_tags.k
JOIN ways w ON w.way_id = temp_tags.way_id
WHERE way_tags.way_id IS NULL;

--  DROP temp table from CSV which holds pre-merge changes
DROP TABLE public.temp_tags;
</code></pre>
<p><br/>
6) Next we update already existing values
    CREATE TABLE IF NOT EXISTS temp_tags (LIKE way_tags);
    ALTER TABLE temp_tags 
    ADD COLUMN IF NOT EXISTS ah_edited boolean default true;</p>
<pre><code>COPY temp_tags(way_id, k, v, version, ah_edited) FROM '/home/map-data/exportedTags.csv' (FORMAT csv, delimiter ';', header false);

UPDATE temp_tags SET ah_edited= TRUE;


--  Add edidtion column to the way_tags and insert unique values which only AH added

ALTER TABLE way_tags
ADD COLUMN IF NOT EXISTS ah_edited boolean default FALSE;

UPDATE way_tags 
SET v=csv_source.v, ah_edited = true
FROM  temp_tags csv_source 
WHERE csv_source.way_id = way_tags.way_id
AND csv_source.k like way_tags.k
AND csv_source.ah_edited = true;

--  DROP temp table from CSV which holds pre-merge changes
DROP TABLE public.temp_tags;
</code></pre>
<p><br/>
<em>I know that I create and drop temporal tables every time, but every script is written to be executable independly</em><br/>
Almost done. Thanks to that We have got our datas in DB but... are not visible in editor. During read process PBF to the editor some inner structures are created that's why We need to save our map to the PBF file and reaload again.<br/>
And again little problem... OSM doesn't know our <code>ah_edited</code> column values. He will restore column, but not values. That way I need to run one little script:<br/></p>
<pre><code>--  Create temp table from CSV which holds pre-merge changes
CREATE TABLE IF NOT EXISTS temp_tags (LIKE way_tags);

ALTER TABLE temp_tags 
ADD COLUMN IF NOT EXISTS ah_edited boolean default TRUE;

COPY temp_tags(way_id, k, v, version, ah_edited) FROM '/home/map-data/exportedTags.csv' (FORMAT csv, delimiter ';', header false);

--  Add edidtion column to the way_tags and insert unique values which only AH added

ALTER TABLE way_tags
ADD COLUMN IF NOT EXISTS ah_edited boolean default FALSE;

UPDATE way_tags 
SET ah_edited = true
FROM  temp_tags
WHERE way_tags.way_id = temp_tags.way_id
AND way_tags.k = temp_tags.k;

--  DROP temp table from CSV which holds pre-merge changes
DROP TABLE public.temp_tags;
</code></pre>
<p>Voila! Done. We have new OSM map with our custom tags transferred.
<br/>
Additional information. I use additional column <code>ah_edited</code> to keep information for the further process that one specific values are edited by me, and I want it to be exported into CSV in the future. After that process, our changeset_id values are set to 0 so we don't have any current information which informations were changed by me as owner -&gt; that's why I use <code>ah_edited</code> column.<br/><br/>
P.S. I know it's complicated, but it works and I couldn't find any answer for my question.</p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/77393/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>04 Nov '20, 11:06</strong>
</p>
<img alt="engopy's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/735ed8c1abf1a1f7b907b78d9594303c?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/19203/engopy">engopy</a><br>
<span class="score" title="126 reputation points">126</span><span title="10 badges"><span class="badge1">●</span><span class="badgecount">10</span></span><span title="10 badges"><span class="silver">●</span><span class="badgecount">10</span></span><span title="15 badges"><span class="bronze">●</span><span class="badgecount">15</span></span><br>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="engopy has no accepted answers">0%</span>
</br></br></p>
</div>
<div class="post-update-info post-update-info-edited">
<p style="line-height:12px;">
<a href="/revisions/77393/">
                edited
                <strong>04 Nov '20, 11:10</strong>
</a>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-77393">
</div>
<div class="comment-tools" id="comment-tools-77393">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-77393-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<div class="paginator-container-left">
</div>
<form action="/questions/77290/answer/" id="fmanswer" method="post">
<input name="csrfmiddlewaretoken" type="hidden" value="dagqjHCQPFbHjrufGJa8fiPWKRltIloO"/>
<div style="clear:both">
</div>
</form>
</div>
</div>
</div>