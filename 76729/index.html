<meta charset="UTF-8"><link rel="stylesheet" type="text/css" href="../style.css"><div id="CALeft">
<div class="headNormal">
<h1><a href="/questions/76729/overpass-api-efficient-location-name-query">Overpass API: Efficient location name query</a></h1>
</div>
<div class="" id="main-body">
<div id="askform">
<table id="question-table" style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/76729/up/" id="post-76729-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-76729-score" title="current number of votes">
    0
</div>
<a class="ajax-command post-vote down" href="/vote/76729/down/" id="post-76729-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="ajax-command favorite-mark" href="/mark_favorite/76729/" id="favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </a>
<div class="favorite-count" id="favorite-count">
</div>
</div>
</td>
<td>
<div id="item-right">
<div class="question-body">
<p>Hi,</p>
<p>I'm looking for the most performant Overpass QL query to search for:</p>
<ul>
<li>a part of a location name</li>
<li>inside a given country</li>
<li>with one of the tags "place", "natural"</li>
</ul>
<p>I tried (Country "de", location "Zugspitze"):</p>
<pre><code>[out:json][timeout:30];
area["ISO3166-1"="DE"][admin_level=2];
node["name"~"Zugspitze"];
out;
</code></pre>
<p>I noticed:</p>
<ul>
<li>part name queries like the one above or regular expression name queries are very slow</li>
<li>actually the fastest one is just to search for node["name"="Zugspitze"] without the area restriction</li>
<li>any restriction makes the query slower</li>
</ul>
<p>E.g. I tried to limit the results like this (to places and naturals):</p>
<pre><code>[out:json][timeout:30];
area["ISO3166-1"="DE"][admin_level=2];
node["name"~"Zugspitze"][~"(place|natural)"~"."];
out;
</code></pre>
<p>My very simple use case: I want to give the user the possibility to search for a location and limit the results to certain place/natural types (like cities or mountains). It's a simple location search like we see on many mapping portals - and all of them are way faster than the above. How is this done with Overpass? Or is there a completely different way I'm missing?</p>
<p>Thanks!</p>
</div>
<div class="tags-container tags" id="question-tags">
<a class="post-tag tag-link-overpass" href="/tags/overpass/" rel="tag" title="see questions tagged 'overpass'">overpass</a>
<a class="post-tag tag-link-overpass-turbo" href="/tags/overpass-turbo/" rel="tag" title="see questions tagged 'overpass-turbo'">overpass-turbo</a>
<a class="post-tag tag-link-location" href="/tags/location/" rel="tag" title="see questions tagged 'location'">location</a>
<a class="post-tag tag-link-overpass-ql" href="/tags/overpass-ql/" rel="tag" title="see questions tagged 'overpass-ql'">overpass-ql</a>
<a class="post-tag tag-link-query" href="/tags/query/" rel="tag" title="see questions tagged 'query'">query</a>
</div>
<div class="post-controls" id="question-controls">
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        asked
        <strong>20 Sep '20, 19:15</strong>
</p>
<img alt="Lukey78's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/b3c6b0ce539881c7f94758a2f63c5541?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/16324/lukey78">Lukey78</a><br/>
<span class="score" title="31 reputation points">31</span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="2 badges"><span class="silver">●</span><span class="badgecount">2</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="Lukey78 has no accepted answers">0%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-76729">
</div>
<div class="comment-tools" id="comment-tools-76729">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-76729-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
<hr/>
<div class="tabBar">
<a name="sort-top"></a>
<div class="headQuestions">
                    One Answer:
                    </div>
<div class="tabsA"><a href="/questions/76729/overpass-api-efficient-location-name-query?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/76729/overpass-api-efficient-location-name-query?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/76729/overpass-api-efficient-location-name-query?sort=newest" title="newest answers will be shown first">newest answers</a><a class="on" href="/questions/76729/overpass-api-efficient-location-name-query?sort=votes" title="most voted answers will be shown first">popular answers</a></div>
</div>
<a name="76733"></a>
<div class="answer" id="answer-container-76733">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/76733/up/" id="post-76733-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-76733-score" title="current number of votes">
    2
</div>
<a class="ajax-command post-vote down" href="/vote/76733/down/" id="post-76733-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>Overpass is a very generic query engine and it emphasizes flexibility over performance. Since everyone is using the same Overpass instance and people have vastly different requirements, optimizing towards one use case would often make a different use case slower.</p>
<p>You will get the best performance by importing OSM data into a PostGIS database and preprocessing/ indexing it according to your special use case.  </p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/76733/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>20 Sep '20, 20:15</strong>
</p>
<img alt="Frederik%20Ramm's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/a2b38d937e70ab39d895d17da0dd1ba4?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/104/frederik-ramm">Frederik Ramm ♦</a><br/>
<span class="score" title="82494 reputation points"><span class="">82.5k</span></span><span title="92 badges"><span class="badge1">●</span><span class="badgecount">92</span></span><span title="720 badges"><span class="silver">●</span><span class="badgecount">720</span></span><span title="1273 badges"><span class="bronze">●</span><span class="badgecount">1273</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="Frederik Ramm has 417 accepted answers">23%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-76733">
<a name="76771"></a>
<div class="comment" id="comment-76771">
<div class="comment-score" id="post-76771-score"></div>
<div class="comment-text"><p>Ok, that makes sense. Thank you.</p>
<p>I created a location database with some additional tag info from a database I use for my map server (created with osm2pgsql) like this:</p>
<pre><code>CREATE TABLE location ("osm_id" BIGINT PRIMARY KEY, "name" TEXT, "ele" TEXT, "lat" FLOAT, "lon" FLOAT, "way" geometry(Point,3857), country_code VARCHAR(3), "place" TEXT, "natural" TEXT, "tourism" TEXT);

INSERT INTO location SELECT osm_id,name,ele,ST_Y(ST_Transform(way, 4326)) AS lat,ST_X(ST_Transform(way, 4326)) AS lon, way, null, "place", "natural", "tourism" FROM planet_osm_point WHERE name IS NOT NULL and ("place" OS NOT NULL or "natural" IS NOT NULL or "tourism" IS NOT NULL);

CREATE INDEX location_name_idx ON location (lower(name));
</code></pre>
<p>Now I just need to find a way to insert the country_code. </p>
<p>I could use the Nominatim API of Overpass to query the ISO3166-1 code for all coordinates with an is_in query based on areas of admin_level=2. </p>
<p>Or is there a better way to do that on the SQL/Postgis level?</p></div>
<div class="comment-info" id="comment-76771-info">
<span class="comment-age">(22 Sep '20, 20:26)</span>
<a class="comment-user userinfo" href="/users/16324/lukey78">Lukey78</a>
</div>
</div>
<a name="76775"></a>
<div class="comment" id="comment-76775">
<div class="comment-score" id="post-76775-score"></div>
<div class="comment-text"><p>A standard osm2pgsql load without <code>--hstore</code> will not give you a country code column on the country boundaries. You'd either have to add that to the config, or use <code>--hstore</code> on import. Then, something like</p>
<pre><code>UPDATE location 
SET country_code = tags-&gt;'ISO3166-1' 
FROM planet_osm_polygon 
WHERE st_contains(planet_osm_polygon.way, location.way)
AND admin_level='2' 
AND boundary='administrative';
</code></pre>
<p>should add country codes to your <code>location</code> table. </p>
<p>There's a little thing I neglected to say in my initial reply; some POIs that you might be interested in could be mapped as an area, not as a point. You might want to repeat your <code>INSERT INTO...</code> query with <code>planet_osm_polygon</code> as the source, this time using <code>st_centroid(way)</code> instead of just <code>way</code> - this will then reduce the polygons to points and add them into your location table.</p></div>
<div class="comment-info" id="comment-76775-info">
<span class="comment-age">(22 Sep '20, 22:16)</span>
<a class="comment-user userinfo" href="/users/104/frederik-ramm">Frederik Ramm ♦</a>
</div>
</div>
<a name="76793"></a>
<div class="comment" id="comment-76793">
<div class="comment-score" id="post-76793-score"></div>
<div class="comment-text"><p>That is very helpful, thank you for the fast and comprehensive answer!</p></div>
<div class="comment-info" id="comment-76793-info">
<span class="comment-age">(23 Sep '20, 19:37)</span>
<a class="comment-user userinfo" href="/users/16324/lukey78">Lukey78</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-76733">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-76733-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<div class="paginator-container-left">
</div>
<form action="/questions/76729/answer/" id="fmanswer" method="post">
<input name="csrfmiddlewaretoken" type="hidden" value="8orwN1gjTYkYj7lT0pWKuuMyvv3DoPBw"/>
<div style="clear:both">
</div>
</form>
</div>
</div>
</div>