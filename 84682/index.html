<meta charset="UTF-8"><link rel="stylesheet" type="text/css" href="../style.css"><div id="CALeft">
<div class="headNormal">
<h1><a href="/questions/84682/osm2pgsql-failed-due-to-error-stop-copy_end">Osm2pgsql failed due to ERROR: stop COPY_END</a></h1>
</div>
<div class="" id="main-body">
<div id="askform">
<table id="question-table" style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/84682/up/" id="post-84682-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-84682-score" title="current number of votes">
    1
</div>
<a class="ajax-command post-vote down" href="/vote/84682/down/" id="post-84682-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="ajax-command favorite-mark" href="/mark_favorite/84682/" id="favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </a>
<div class="favorite-count" id="favorite-count">
</div>
</div>
</td>
<td>
<div id="item-right">
<div class="question-body">
<p>We are facing a problem with a closed connection with osm2pgsql when performing the daily update of the database from "download.geofabrik.de", and the region in question is Brazil.
We have three environments with the same settings (CPU, memory and disk), but the problem only occurs in one of them, which is stage, dev and pro work well.</p>
<p>Command:</p>
<p>osm2pgsql -a --slim -e13-20 -d dbhom --number-processes 4 --cache 3042 --tag-transform-script /opt/programs/openstreetmap-carto/5.3.1/hom_openstreetmap/openstreetmap-carto/openstreetmap -carto.lua -S /opt/programas/openstreetmap-carto/5.3.1/hom_openstreetmap/openstreetmap-carto/openstreetmap-carto.style -o /opt/appfiles/hom_openstreetmap/dirty_tiles.38216 /opt/appfiles/hom_openstreetmap/changes .osc.gz</p>
<p>Log:</p>
<p>osm2pgsql version 0.92.0 (64 bit id space)
...
Reading in file: /opt/appfiles/hom_openstreetmap/changes.osc.gz
Using XML parser.
Processing: Node(60k 0.2k/s) Way(0k 0.00k/s) Relation(0 0.00/s)node cache: stored: 63588(100.00%), storage efficiency: 48.50% (dense blocks: 2, sparse nodes: 57356), hit rate: -nan%
Osm2pgsql failed due to ERROR: stop COPY_END for planet_osm_roads failed: server closed the connection unexpectedly
        This probably means the server terminated abnormally
        before or while processing the request.</p>
<p>On the PostgreSQL side, we have this message below with a few minutes after the connection with the database started. However, the execution in the application part continues and is only finished minutes later.</p>
<p>2022-06-02 09:36:38 -03 [35713]: [1-1] user=usr,db=dbhom LOG: could not receive data from client: Connection reset by peer</p>
<p>We have the application server, where osm2pgsql runs, and we have the database with the same settings both.</p>
<ul>
<li>4 CPUs</li>
<li>8 GB RAM</li>
<li>PostgreSQL 12</li>
<li>PostGIS 3.1</li>
</ul>
<p>The software versions used in the 3 environments are the same and have been recently revised.</p>
</div>
<div class="tags-container tags" id="question-tags">
<a class="post-tag tag-link-osm2pgsql" href="/tags/osm2pgsql/" rel="tag" title="see questions tagged 'osm2pgsql'">osm2pgsql</a>
</div>
<div class="post-controls" id="question-controls">
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        asked
        <strong>02 Jun '22, 18:20</strong>
</p>
<img alt="asuzano's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/75861b5236ce6ac694421f92da06cadd?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/21848/asuzano">asuzano</a><br/>
<span class="score" title="26 reputation points">26</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="asuzano has no accepted answers">0%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-84682">
</div>
<div class="comment-tools" id="comment-tools-84682">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-84682-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
<hr/>
<div class="tabBar">
<a name="sort-top"></a>
<div class="headQuestions">
                    One Answer:
                    </div>
<div class="tabsA"><a href="/questions/84682/osm2pgsql-failed-due-to-error-stop-copy_end?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/84682/osm2pgsql-failed-due-to-error-stop-copy_end?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/84682/osm2pgsql-failed-due-to-error-stop-copy_end?sort=newest" title="newest answers will be shown first">newest answers</a><a class="on" href="/questions/84682/osm2pgsql-failed-due-to-error-stop-copy_end?sort=votes" title="most voted answers will be shown first">popular answers</a></div>
</div>
<a name="84684"></a>
<div class="answer" id="answer-container-84684">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/84684/up/" id="post-84684-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-84684-score" title="current number of votes">
    1
</div>
<a class="ajax-command post-vote down" href="/vote/84684/down/" id="post-84684-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>I'd start with upgrading your osm2pgsql version to the latest one. You say the environment was "revised", but osm2pgsql 0.92 is from December 2016, and is by now heavily outdated.</p>
<p>If you upgrade to 1.6.0, you'll get the added benefit of the new "flex" configuration options of osm2pgsql (see <a href="https://osm2pgsql.org/doc/manual.html">https://osm2pgsql.org/doc/manual.html</a> and <a href="https://osm2pgsql.org/doc/manual.html#the-flex-output),">https://osm2pgsql.org/doc/manual.html#the-flex-output),</a> which gives much greater flexibility in defining the output database schema.</p>
<p>Also, 8GB RAM is low end nowadays. Although your Brazil extract may not be that taxing, as being still quite modest in size at 1.4GB PBF, more RAM never hurts for caching purposes on the OS and database level.</p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/84684/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>02 Jun '22, 20:56</strong>
</p>
<img alt="mboeringa's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/dc8a1ef54d3e25744ee52d1ad1459a81?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/9580/mboeringa">mboeringa</a><br/>
<span class="score" title="1542 reputation points"><span class="">1.5k</span></span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="15 badges"><span class="silver">●</span><span class="badgecount">15</span></span><span title="27 badges"><span class="bronze">●</span><span class="badgecount">27</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="mboeringa has 4 accepted answers">9%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-84684">
</div>
<div class="comment-tools" id="comment-tools-84684">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-84684-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<div class="paginator-container-left">
</div>
<form action="/questions/84682/answer/" id="fmanswer" method="post">
<input name="csrfmiddlewaretoken" type="hidden" value="T2B4EMFuYYJ9xFPeI8p8n3hvJSUN0xL5"/>
<div style="clear:both">
</div>
</form>
</div>
</div>
</div>