<meta charset="UTF-8"><link rel="stylesheet" type="text/css" href="../style.css"><div id="CALeft">
<div class="headNormal">
<h1><a href="/questions/71846/gather-amenities-sorted-by-county-borders">Gather amenities sorted by county borders</a></h1>
</div>
<div class="" id="main-body">
<div id="askform">
<table id="question-table" style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/71846/up/" id="post-71846-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-71846-score" title="current number of votes">
    0
</div>
<a class="ajax-command post-vote down" href="/vote/71846/down/" id="post-71846-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="ajax-command favorite-mark" href="/mark_favorite/71846/" id="favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </a>
<div class="favorite-count" id="favorite-count">
</div>
</div>
</td>
<td>
<div id="item-right">
<div class="question-body">
<p>Hello everyone, </p>
<p>my goal is to gather the number of certain amenitys (for example: amenity=bar) in Germany, but sorted in a csv by the county border (admin_level=6) they belong to.</p>
<p>This works fine for one county border in Overpass Turbo:</p>
<pre><code>[out:csv(::type,::id, name,"addr:postcode", "addr:city")];
area[admin_level=6]["name"="Bautzen"];  
( 
   node["amenity"="bar"](area);
   way["amenity"="bar"](area);
   rel["amenity"="bar"](area);
);
out body;
&gt;;
out skel qt;
</code></pre>
<p>But Germany has 403 of them, so inserting each of them in a new query would be way to much effort. 
On the other hand I don't now how to match the amenitys, when I do a seach for the whole of Germany. For example, this isn't possible via the postcode, because not every amenity have one assigned.</p>
<p>Is there a good and faster way to gather these informations with the right assignment ?</p>
</div>
<div class="tags-container tags" id="question-tags">
<a class="post-tag tag-link-region" href="/tags/region/" rel="tag" title="see questions tagged 'region'">region</a>
<a class="post-tag tag-link-csv" href="/tags/csv/" rel="tag" title="see questions tagged 'csv'">csv</a>
<a class="post-tag tag-link-overpass-turbo" href="/tags/overpass-turbo/" rel="tag" title="see questions tagged 'overpass-turbo'">overpass-turbo</a>
<a class="post-tag tag-link-amenity" href="/tags/amenity/" rel="tag" title="see questions tagged 'amenity'">amenity</a>
</div>
<div class="post-controls" id="question-controls">
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        asked
        <strong>26 Nov '19, 17:00</strong>
</p>
<img alt="Detektiv%20Mittens's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/12d3c077816229dbe8dd6863592e88f5?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/17498/detektiv-mittens">Detektiv Mit...</a><br/>
<span class="score" title="26 reputation points">26</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="3 badges"><span class="bronze">●</span><span class="badgecount">3</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="Detektiv Mittens has no accepted answers">0%</span>
</p>
</div>
<div class="post-update-info post-update-info-edited">
<p style="line-height:12px;">
<a href="/revisions/71846/">
                edited
                <strong>26 Nov '19, 19:22</strong>
</a>
</p>
<img alt="Frederik%20Ramm's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/a2b38d937e70ab39d895d17da0dd1ba4?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/104/frederik-ramm">Frederik Ramm ♦</a><br/>
<span class="score" title="82494 reputation points"><span class="">82.5k</span></span><span title="92 badges"><span class="badge1">●</span><span class="badgecount">92</span></span><span title="720 badges"><span class="silver">●</span><span class="badgecount">720</span></span><span title="1273 badges"><span class="bronze">●</span><span class="badgecount">1273</span></span></p>
</div>
</div>
<div class="comments-container" id="comments-container-71846">
</div>
<div class="comment-tools" id="comment-tools-71846">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-71846-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
<hr/>
<div class="tabBar">
<a name="sort-top"></a>
<div class="headQuestions">
                    One Answer:
                    </div>
<div class="tabsA"><a href="/questions/71846/gather-amenities-sorted-by-county-borders?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/71846/gather-amenities-sorted-by-county-borders?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/71846/gather-amenities-sorted-by-county-borders?sort=newest" title="newest answers will be shown first">newest answers</a><a class="on" href="/questions/71846/gather-amenities-sorted-by-county-borders?sort=votes" title="most voted answers will be shown first">popular answers</a></div>
</div>
<a name="71847"></a>
<div class="answer accepted-answer" id="answer-container-71847">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/71847/up/" id="post-71847-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-71847-score" title="current number of votes">
    3
</div>
<a class="ajax-command post-vote down" href="/vote/71847/down/" id="post-71847-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="accept-answer on" href="/accept_answer/71847/" rel="nofollow" title="Detektiv Mittens has selected this answer as the correct answer">
</a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>Since it looks like you want to make many of these queries, don't hammer someone else's server with it - do it yourself. Load the OSM data for Germany into a PostGIS database with osm2pgsql, then run this query:</p>
<pre><code>SELECT 
  county.name, count(*)
FROM 
  planet_osm_point poi, 
  planet_osm_polygon county
WHERE 
  poi.amenity='bar'
  AND county.boundary='administrative'
  AND county.admin_level='6'
  AND st_contains(county.way, poi.way)
GROUP BY county.name;
</code></pre>
<p>This will only give you the point-shaped bars, and you have to repeat this with "planet_osm_polygon poi" instead of "planet_osm_point poi" to count the polygon-shaped ones. (You can also count both at once but that makes the query harder to understand.) You can even count a large number of different amenities in one go:</p>
<pre><code>SELECT 
  poi.amenity, county.name, count(*)
FROM 
  planet_osm_point poi, 
  planet_osm_polygon county
WHERE 
  poi.amenity in ('bar', 'restaurant', 'pub')
  AND county.boundary='administrative'
  AND county.admin_level='6'
  AND st_contains(county.way, poi.way)
GROUP BY poi.amenity, county.name;
</code></pre>
<p>(BTW, note that these queries will omit Hamburg and Berlin due to lack of an adminlevel 6 boundary.)</p>
<p>If you are interested in OSM statistics then using your own PostGIS and learning a little SQL is really useful.</p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/71847/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>26 Nov '19, 17:38</strong>
</p>
<img alt="Frederik%20Ramm's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/a2b38d937e70ab39d895d17da0dd1ba4?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/104/frederik-ramm">Frederik Ramm ♦</a><br/>
<span class="score" title="82494 reputation points"><span class="">82.5k</span></span><span title="92 badges"><span class="badge1">●</span><span class="badgecount">92</span></span><span title="720 badges"><span class="silver">●</span><span class="badgecount">720</span></span><span title="1273 badges"><span class="bronze">●</span><span class="badgecount">1273</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="Frederik Ramm has 417 accepted answers">23%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-71847">
<a name="71891"></a>
<div class="comment" id="comment-71891">
<div class="comment-score" id="post-71891-score"></div>
<div class="comment-text"><p>Thanks for your detailed answer. I hoped that there was a more simpler way, but I will try to fiddle around with PostGis and see how far I get.</p></div>
<div class="comment-info" id="comment-71891-info">
<span class="comment-age">(28 Nov '19, 18:04)</span>
<a class="comment-user userinfo" href="/users/17498/detektiv-mittens">Detektiv Mit...</a>
</div>
</div>
<a name="72097"></a>
<div class="comment" id="comment-72097">
<div class="comment-score" id="post-72097-score"></div>
<div class="comment-text"><p>Hey I have some further questions, if you don't mind and if it is still fitting for this thread. I successfully build the database and run different queries, like you showed me. </p>
<p>I am wondering now about the accuracies of the data. When I am for example run a query for ‘amenity=prison’ I got as a result for planet_osm_point poi:  34 and for planet_osm_polygon county: 285 in total. The official statistic shows the number of 179 prisons in whole Germany.</p>
<p>I am wondering why the difference is so large? I am aware that OSM-Data isn’t often complete, but then I would have expected the number to be smaller than the official one. Do you always have to expect some points to be counted twice? 
And is normally legit to combine ‘point’ and ‘polygon’ or does it become more inaccurate then? Thanks for your help!</p></div>
<div class="comment-info" id="comment-72097-info">
<span class="comment-age">(13 Dec '19, 16:43)</span>
<a class="comment-user userinfo" href="/users/17498/detektiv-mittens">Detektiv Mit...</a>
</div>
</div>
<a name="72101"></a>
<div class="comment" id="comment-72101">
<div class="comment-score" id="post-72101-score">1</div>
<div class="comment-text"><p>Most likely you're hitting issues where there's a prison complex consisting of 10 buildings and each is tagged, individually, as amenity=prison. There are various ways to address this problem. One is to use a suitable "clustering" function in PostGIS, and tell it to combine into one all "prisons" that are less than, say, 500m of each other.</p>
<p>For example, there are four prisons in OSM here: <a href="https://www.openstreetmap.org/#map=17/52.54077/13.32037">https://www.openstreetmap.org/#map=17/52.54077/13.32037</a> when in reality it's either one or two depending on what you count.</p></div>
<div class="comment-info" id="comment-72101-info">
<span class="comment-age">(13 Dec '19, 18:43)</span>
<a class="comment-user userinfo" href="/users/104/frederik-ramm">Frederik Ramm ♦</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-71847">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-71847-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<div class="paginator-container-left">
</div>
<form action="/questions/71846/answer/" id="fmanswer" method="post">
<input name="csrfmiddlewaretoken" type="hidden" value="Mp1GMsOBBYj1Cll4IvofCpLDo7NL8Y18"/>
<div style="clear:both">
</div>
</form>
</div>
</div>
</div>