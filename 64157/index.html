<meta charset="utf-8"/><link href="../style.css" rel="stylesheet" type="text/css"/><div id="CALeft"><center><a href="../"><img id="ll" src="https://help.openstreetmap.org/upfiles/osm_help_logo_6.png"/></a></center>
<div class="headNormal">
<h1><a href="/questions/64157/getting-504-gateway-timeout-with-valid-document-was-not-found-in-the-cache-and-only-if-cached-directive-was-specified-for-some-tiles">Getting 504 Gateway Timeout with "Valid document was not found in the cache and only-if-cached directive was specified" for some tiles</a></h1>
</div>
<div class="" id="main-body">
<div id="askform">
<table id="question-table" style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/64157/up/" id="post-64157-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-64157-score" title="current number of votes">
    1
</div>
<a class="ajax-command post-vote down" href="/vote/64157/down/" id="post-64157-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="ajax-command favorite-mark" href="/mark_favorite/64157/" id="favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </a>
<div class="favorite-count" id="favorite-count">
</div>
</div>
</td>
<td>
<div id="item-right">
<div class="question-body">
<p>Requesting, e.g., <a href="https://a.tile.openstreetmap.org/17/67225/43067.png">https://a.tile.openstreetmap.org/17/67225/43067.png</a> <s>shows</s> showed:</p>
<blockquote>
<p>The following error was encountered while trying to retrieve the URL: <a href="http://b.tile.openstreetmap.org/17/67224/43067.png">http://b.tile.openstreetmap.org/17/67224/43067.png</a></p>
<p>Valid document was not found in the cache and only-if-cached directive was specified.  </p>
<p>You have issued a request with a only-if-cached cache control directive. The document was not found in the cache, or it required revalidation prohibited by the only-if-cached directive.</p>
</blockquote>
<p>I really don't think the browser is sending that header. Running the following from a different location (just be sure it's not some network issue at work) <s>yields</s> did yield the very same error:</p>
<p><code>curl 'https://b.tile.openstreetmap.org/17/67224/43067.png' -H 'Referer: <a href="http://127.0.0.1:4200/demo/embed-mjgp2.html'">http://127.0.0.1:4200/demo/embed-mjgp2.html'</a> -H 'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.79 Safari/537.36' --compressed --verbose</code></p>
<p>...showing no header like that:</p>
<pre><code>&gt; GET /17/67224/43067.png HTTP/2
&gt; Host: b.tile.openstreetmap.org
&gt; Accept: */*
&gt; Accept-Encoding: deflate, gzip
&gt; Referer: <a href="http://127.0.0.1:4200/demo/embed-mjgp2.html">http://127.0.0.1:4200/demo/embed-mjgp2.html</a>
&gt; User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.79 Safari/537.36
...
&lt; HTTP/2 504
&lt; server: nginx
&lt; date: Mon, 11 Jun 2018 08:21:34 GMT
&lt; content-type: text/html
&lt; content-length: 1445
&lt; x-squid-error: ERR_ONLY_IF_CACHED_MISS 0
&lt; x-cache: MISS from konqi.openstreetmap.org
&lt; x-cache-lookup: MISS from konqi.openstreetmap.org:3128
&lt; x-cache: MISS from trogdor.openstreetmap.org
&lt; x-cache-lookup: MISS from trogdor.openstreetmap.org:3128
&lt; via: 1.0 konqi.openstreetmap.org:3128 (squid/2.7.STABLE9), 1.1 trogdor.openstreetmap.org (squid/3.5.12)
&lt; strict-transport-security: max-age=31536000; includeSubDomains
</code></pre>
<p>So I guess some internal proxy on the OSM server is adding that header?</p>
</div>
<div class="tags-container tags" id="question-tags">
<a class="post-tag tag-link-tiles" href="/tags/tiles/" rel="tag" title="see questions tagged 'tiles'">tiles</a>
<a class="post-tag tag-link-cache" href="/tags/cache/" rel="tag" title="see questions tagged 'cache'">cache</a>
<a class="post-tag tag-link-tileserver" href="/tags/tileserver/" rel="tag" title="see questions tagged 'tileserver'">tileserver</a>
</div>
<div class="post-controls" id="question-controls">
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        asked
        <strong>11 Jun '18, 10:42</strong>
</p>
<img alt="avbentem's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/04b5f00a8624ff5e7a3db486b96b125c?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/15244/avbentem">avbentem</a><br/>
<span class="score" title="31 reputation points">31</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="4 badges"><span class="bronze">●</span><span class="badgecount">4</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="avbentem has no accepted answers">0%</span>
</p>
</div>
<div class="post-update-info post-update-info-edited">
<p style="line-height:12px;">
<a href="/revisions/64157/">
                edited
                <strong>11 Jun '18, 20:20</strong>
</a>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-64157">
<a name="64161"></a>
<div class="comment" id="comment-64161">
<div class="comment-score" id="post-64161-score">2</div>
<div class="comment-text"><p>Similar reports at <a href="https://stackoverflow.com/questions/50757554/openstreetmap-often-sends-gateway-timeout-error">https://stackoverflow.com/questions/50757554/openstreetmap-often-sends-gateway-timeout-error</a> and <a href="https://stackoverflow.com/questions/50757102/open-street-map-504">https://stackoverflow.com/questions/50757102/open-street-map-504</a></p></div>
<div class="comment-info" id="comment-64161-info">
<span class="comment-age">(11 Jun '18, 13:09)</span>
<a class="comment-user userinfo" href="/users/158/scai">scai ♦</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-64157">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-64157-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
<hr/>
<div class="tabBar">
<a name="sort-top"></a>
<div class="headQuestions">
                    One Answer:
                    </div>
<div class="tabsA"><a href="/questions/64157/getting-504-gateway-timeout-with-valid-document-was-not-found-in-the-cache-and-only-if-cached-directive-was-specified-for-some-tiles?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/64157/getting-504-gateway-timeout-with-valid-document-was-not-found-in-the-cache-and-only-if-cached-directive-was-specified-for-some-tiles?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/64157/getting-504-gateway-timeout-with-valid-document-was-not-found-in-the-cache-and-only-if-cached-directive-was-specified-for-some-tiles?sort=newest" title="newest answers will be shown first">newest answers</a><a class="on" href="/questions/64157/getting-504-gateway-timeout-with-valid-document-was-not-found-in-the-cache-and-only-if-cached-directive-was-specified-for-some-tiles?sort=votes" title="most voted answers will be shown first">popular answers</a></div>
</div>
<a name="64162"></a>
<div class="answer accepted-answer" id="answer-container-64162">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/64162/up/" id="post-64162-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-64162-score" title="current number of votes">
    3
</div>
<a class="ajax-command post-vote down" href="/vote/64162/down/" id="post-64162-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="accept-answer on" href="/accept_answer/64162/" rel="nofollow" title="avbentem has selected this answer as the correct answer">
</a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>There have been some issues with the squid proxy in recent days. The sysadmins are working on it.</p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/64162/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>11 Jun '18, 18:01</strong>
</p>
<img alt="Richard's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/08324717c25d6067fa4ff23ef37d455f?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/5/richard">Richard ♦</a><br/>
<span class="score" title="30902 reputation points"><span class="">30.9k</span></span><span title="44 badges"><span class="badge1">●</span><span class="badgecount">44</span></span><span title="279 badges"><span class="silver">●</span><span class="badgecount">279</span></span><span title="412 badges"><span class="bronze">●</span><span class="badgecount">412</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="Richard has 98 accepted answers">18%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-64162">
</div>
<div class="comment-tools" id="comment-tools-64162">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-64162-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<div class="paginator-container-left">
</div>
<form action="/questions/64157/answer/" id="fmanswer" method="post">
<input name="csrfmiddlewaretoken" type="hidden" value="Ez2YQJZADyO4aBMU3X4i9NqqQAp8LfWp"/>
<div style="clear:both">
</div>
</form>
</div>
</div>
</div>