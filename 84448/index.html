<meta charset="UTF-8"><link rel="stylesheet" type="text/css" href="../style.css"><div id="CALeft">
<div class="headNormal">
<h1><a href="/questions/84448/issue-with-selfhosted-nominatim-empty-reply-for-postcodes">Issue with selfhosted nominatim - empty reply for postcodes</a></h1>
</div>
<div class="" id="main-body">
<div id="askform">
<table id="question-table" style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/84448/up/" id="post-84448-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-84448-score" title="current number of votes">
    0
</div>
<a class="ajax-command post-vote down" href="/vote/84448/down/" id="post-84448-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="ajax-command favorite-mark" href="/mark_favorite/84448/" id="favorite-mark" rel="nofollow" title="mark/unmark this question as favorite (click again to cancel)"> </a>
<div class="favorite-count" id="favorite-count">
</div>
</div>
</td>
<td>
<div id="item-right">
<div class="question-body">
<p>Hello, 
we got an issue with private instance using official docker image. We have issue with some postal codes. For example the public api returns correct data (the issue also occurs with street name and number) for the city: </p>
<p><a href="https://nominatim.openstreetmap.org/search.php?postalcode=89-501&amp;format=jsonv2">https://nominatim.openstreetmap.org/search.php?postalcode=89-501&amp;format=jsonv2</a></p>
<p>but our instance returns empty reply. However, when refering to county postcode:</p>
<p><a href="https://nominatim.openstreetmap.org/search.php?postalcode=89-500&amp;format=jsonv2">https://nominatim.openstreetmap.org/search.php?postalcode=89-500&amp;format=jsonv2</a></p>
<p>we do get proper reply from our selfhosted instance, including detailed query with street name/number (we get correct geolocation using the general county post-code)</p>
<p>Our instance configuration is as follows (deployed using docker compose):</p>
<p>POSTGRES_SHARED_BUFFERS: "2GB"</p>
<p>POSTGRES_MAINTENANCE_WORK_MEM: "10GB"</p>
<p>POSTGRES_AUTOVACUUM_WORK_MEM: "2GB"</p>
<p>POSTGRES_WORK_MEM: "50MB"</p>
<p>POSTGRES_EFFECTIVE_CACHE_SIZE: "8GB"</p>
<p>PBF_URL: "https://download.geofabrik.de/europe/poland-latest.osm.pbf"
REPLICATION_URL: "https://download.geofabrik.de/europe/poland-updates/"
IMPORT_STYLE: "address"</p>
<p>Docker image we use is: mediagis/nominatim:4.0.</p>
<p>Checked for update using:</p>
<p>sudo -u nominatim nominatim replication -v --check-for-updates --project-dir /nominatim</p>
<p>and its up-to-date.
Any hints on what may be the issue here? Can too low level import style have anything to do with it?</p>
<p>The 89-500 is general county code <a href="https://znajdzkodpocztowy.pl/szukaj/mk-89-500/,">https://znajdzkodpocztowy.pl/szukaj/mk-89-500/,</a> the 89-501 is strictly city code <a href="https://znajdzkodpocztowy.pl/szukaj/mk-89-501/">https://znajdzkodpocztowy.pl/szukaj/mk-89-501/</a> . The issue extends to other cities as well. If address is specified with general county code everything works, but when local city code is used, reply is empty. The issue does not occur on public api - all local city codes give correct rply. Anything in config we should change? </p>
</div>
<div class="tags-container tags" id="question-tags">
<a class="post-tag tag-link-problem" href="/tags/problem/" rel="tag" title="see questions tagged 'problem'">problem</a>
<a class="post-tag tag-link-nominatim" href="/tags/nominatim/" rel="tag" title="see questions tagged 'nominatim'">nominatim</a>
<a class="post-tag tag-link-docker" href="/tags/docker/" rel="tag" title="see questions tagged 'docker'">docker</a>
<a class="post-tag tag-link-server" href="/tags/server/" rel="tag" title="see questions tagged 'server'">server</a>
<a class="post-tag tag-link-postcode" href="/tags/postcode/" rel="tag" title="see questions tagged 'postcode'">postcode</a>
</div>
<div class="post-controls" id="question-controls">
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        asked
        <strong>12 May '22, 08:53</strong>
</p>
<img alt="mzaw9's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/cdfa325e85e9c7a9278241e2cb943446?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/21757/mzaw9">mzaw9</a><br/>
<span class="score" title="14 reputation points">14</span><span title="1 badges"><span class="badge1">●</span><span class="badgecount">1</span></span><span title="1 badges"><span class="silver">●</span><span class="badgecount">1</span></span><span title="2 badges"><span class="bronze">●</span><span class="badgecount">2</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="mzaw9 has no accepted answers">0%</span>
</p>
</div>
<div class="post-update-info post-update-info-edited">
<p style="line-height:12px;">
<a href="/revisions/84448/">
                edited
                <strong>12 May '22, 10:57</strong>
</a>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-84448">
<a name="84451"></a>
<div class="comment" id="comment-84451">
<div class="comment-score" id="post-84451-score">1</div>
<div class="comment-text"><p>When was the initial import?</p></div>
<div class="comment-info" id="comment-84451-info">
<span class="comment-age">(12 May '22, 09:19)</span>
<a class="comment-user userinfo" href="/users/2921/lonvia">lonvia</a>
</div>
</div>
<a name="84452"></a>
<div class="comment" id="comment-84452">
<div class="comment-score" id="post-84452-score"></div>
<div class="comment-text"><p>around 2 months ago.
replication is working once/day
the issue is wide - it has county codes, but missing local city-codes; however, it works on public api.</p>
<p>can this: <a href="https://github.com/osm-search/Nominatim/blob/2d1a22705f7f2f067f2c839c32caf55941a37b01/settings/import-full.style#L18">https://github.com/osm-search/Nominatim/blob/2d1a22705f7f2f067f2c839c32caf55941a37b01/settings/import-full.style#L18</a> 
difference between address and full import be a culprit?</p></div>
<div class="comment-info" id="comment-84452-info">
<span class="comment-age">(12 May '22, 09:22)</span>
<a class="comment-user userinfo" href="/users/21757/mzaw9">mzaw9</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-84448">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-84448-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
<hr/>
<div class="tabBar">
<a name="sort-top"></a>
<div class="headQuestions">
                    One Answer:
                    </div>
<div class="tabsA"><a href="/questions/84448/issue-with-selfhosted-nominatim-empty-reply-for-postcodes?sort=active" title="most recently updated answers/comments will be shown first">active answers</a><a href="/questions/84448/issue-with-selfhosted-nominatim-empty-reply-for-postcodes?sort=oldest" title="oldest answers will be shown first">oldest answers</a><a href="/questions/84448/issue-with-selfhosted-nominatim-empty-reply-for-postcodes?sort=newest" title="newest answers will be shown first">newest answers</a><a class="on" href="/questions/84448/issue-with-selfhosted-nominatim-empty-reply-for-postcodes?sort=votes" title="most voted answers will be shown first">popular answers</a></div>
</div>
<a name="84500"></a>
<div class="answer accepted-answer" id="answer-container-84500">
<table style="width:100%;">
<tr>
<td style="width:30px;vertical-align:top">
<div class="vote-buttons">
<a class="ajax-command post-vote up" href="/vote/84500/up/" id="post-84500-upvote" rel="nofollow" title="I like this post (click again to cancel)"> </a>
<div class="post-score" id="post-84500-score" title="current number of votes">
    2
</div>
<a class="ajax-command post-vote down" href="/vote/84500/down/" id="post-84500-downvote" rel="nofollow" title="I dont like this post (click again to cancel)"> </a>
<a class="accept-answer on" href="/accept_answer/84500/" rel="nofollow" title="mzaw9 has selected this answer as the correct answer">
</a>
</div>
</td>
<td>
<div class="item-right">
<div class="answer-body">
<p>Quick answer: You need to update the postcode data on your instance with the following command: <code>nominatim refresh --postcode</code>. Make sure that there are no updates running at the same time. The update takes between 20min and an hour, depending on your hardware.</p>
<p>Background: Postcode data is not directly available in OSM. There are only postcodes as part of addresses. To make search for postcodes work, Nominatim takes the postcodes from all the address and computes a centroid point for each of them. This is a rather expensive process, so it is not done as part of the regular updates. You have to occasionally run the process manually using the command above.</p>
<p>Addresses with the postcode '89-501' were first entered in OSM only a couple of weeks ago. That's why your instance does not have them yet. If you have regularly applied updates, the data is there. Recomputing the postcode centroids will make them searchable.</p>
</div>
<div class="answer-controls post-controls">
<span class="action-link"><a class="ajax-command withprompt copy" href="/answer_link/84500/" rel="nofollow" title="answer permanent link">permanent link</a></span>
</div>
<div class="post-update-info-container">
<div class="post-update-info post-update-info-user">
<p style="line-height:12px;">
        answered
        <strong>18 May '22, 08:34</strong>
</p>
<img alt="lonvia's gravatar image" class="gravatar" height="32" src="https://secure.gravatar.com/avatar/d888b712d85dee0aa304297f2dc697c7?s=32&amp;d=identicon&amp;r=g" width="32"/>
<p><a href="/users/2921/lonvia">lonvia</a><br/>
<span class="score" title="6213 reputation points"><span class="">6.2k</span></span><span title="2 badges"><span class="badge1">●</span><span class="badgecount">2</span></span><span title="57 badges"><span class="silver">●</span><span class="badgecount">57</span></span><span title="89 badges"><span class="bronze">●</span><span class="badgecount">89</span></span><br/>
<span class="accept_rate" title="Rate of the user's accepted answers">accept rate:</span>
<span title="lonvia has 43 accepted answers">40%</span>
</p>
</div>
</div>
<div class="comments-container" id="comments-container-84500">
<a name="84527"></a>
<div class="comment" id="comment-84527">
<div class="comment-score" id="post-84527-score"></div>
<div class="comment-text"><p>thanks, that helped; we also automated the refresh to once a day (same as update)</p></div>
<div class="comment-info" id="comment-84527-info">
<span class="comment-age">(19 May '22, 14:17)</span>
<a class="comment-user userinfo" href="/users/21757/mzaw9">mzaw9</a>
</div>
</div>
</div>
<div class="comment-tools" id="comment-tools-84500">
</div>
<div class="clear"></div>
<div class="comment-form-container" id="comment-84500-form-container">
</div>
<div class="clear"></div>
</div>
</td>
</tr>
</table>
</div>
<div class="paginator-container-left">
</div>
<form action="/questions/84448/answer/" id="fmanswer" method="post">
<input name="csrfmiddlewaretoken" type="hidden" value="UZhHKqNimiUFwGbee0KUYfMhvE6JvXwP"/>
<div style="clear:both">
</div>
</form>
</div>
</div>
</div>